<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Species Tracking - Whale Watchers Atlas</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="description" content="Track individual whale species migration patterns with animated heatmaps.">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.js"></script>
    <link rel="stylesheet" href="styles.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --nav-height: 72px;
            --mobile-ctrl-top: calc(var(--nav-height) + 20px); /* Shared height for projection + floating buttons */

            /* Month slider position - single source of truth (adjust these values) */
            --slider-left: 8px;
            --slider-bottom: 170px; /* Default for 900px - lower = closer to species bar */
        }

        /* ============================================================
           CSS RESET & BASE
           ============================================================ */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #0a1628;
        }

        #navbar {
            z-index: 1000;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: var(--nav-height);
            display: flex;
            align-items: center;
        }

        /* Navbar sizing tweaks to keep a single row */
        #navbar .nav-container {
            padding: 8px 14px;
            gap: 12px;
            flex-wrap: nowrap;
            height: 100%;
            width: 100%;
            max-width: none;
            margin: 0;
        }

        #navbar .nav-brand {
            padding: 8px 0;
            gap: 8px;
            font-size: 18px;
            margin-right: auto;
        }

        #navbar .nav-links {
            gap: 6px;
            flex-wrap: nowrap;
        }

        #navbar .nav-link {
            padding: 8px 12px;
            font-size: 13px;
            white-space: nowrap;
        }

        /* Hamburger toggle (shown on mobile) */
        #navbar .nav-toggle {
            display: none;
            width: 38px;
            height: 38px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.1);
            color: #fff;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-direction: column;
            cursor: pointer;
        }

        #navbar .nav-toggle span {
            display: block;
            width: 18px;
            height: 2px;
            background: currentColor;
            border-radius: 4px;
        }

        /* Mobile nav behavior */
        @media (max-width: 900px) {
            #navbar .nav-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            #navbar .nav-links {
                display: none;
                position: absolute;
                top: var(--nav-height);
                left: 0;
                right: 0;
                padding: 12px 16px;
                background: rgba(10, 35, 66, 0.96);
                flex-direction: column;
                gap: 8px;
                box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
            }

            #navbar.nav-open .nav-links {
                display: flex;
            }

            #navbar .nav-toggle {
                display: inline-flex;
            }

            #navbar .nav-links .nav-link {
                width: 100%;
                text-align: left;
            }
        }

        /* ============================================================
           LAYOUT: Fixed sidebar + map area
           ============================================================ */
        .sidebar {
            position: fixed;
            top: var(--nav-height);
            left: 0;
            width: 380px;
            height: calc(100vh - var(--nav-height));
            background: rgba(10, 22, 40, 0.98);
            backdrop-filter: blur(10px);
            z-index: 50;
            display: flex;
            flex-direction: column;
        }

        .map-wrapper {
            position: fixed;
            top: var(--nav-height);
            left: 380px;
            right: 0;
            bottom: 0;
            background: #0a1628;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100% !important;
            height: 100% !important;
            background: #0a1628;
            max-width: none !important;
            margin: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        /* Force Mapbox canvas to fill container */
        #map.mapboxgl-map {
            width: 100% !important;
            height: 100% !important;
        }

        .mapboxgl-canvas-container,
        .mapboxgl-canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* ============================================================
           SIDEBAR HEADER
           ============================================================ */
        .sidebar-header {
            padding: 32px 20px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 12px;
            position: relative;
        }

        .sidebar-title {
            font-family: 'Oswald', sans-serif;
            font-size: 22px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .sidebar-description {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
        }

        .sidebar-stats {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 12px;
            margin-bottom: 8px;
        }

        .sidebar-stat {
            text-align: center;
        }

        .sidebar-stat-value {
            font-family: 'Oswald', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: #1a6db0;
            line-height: 1;
        }

        .sidebar-stat-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-top: 4px;
        }

        /* Map Tips Button & Tooltip */
        .map-tips-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 10px;
            padding: 6px 12px;
            background: rgba(78, 205, 196, 0.15);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 6px;
            color: #4ecdc4;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .map-tips-btn:hover {
            background: rgba(78, 205, 196, 0.25);
            border-color: rgba(78, 205, 196, 0.5);
        }

        .map-tips-btn svg {
            width: 14px;
            height: 14px;
        }

        .map-tips-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            padding: 12px 14px;
            background: rgba(10, 35, 66, 0.98);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 8px;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .map-tips-tooltip.show {
            display: block;
        }

        .map-tips-tooltip ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .map-tips-tooltip li {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .map-tips-tooltip li:last-child {
            margin-bottom: 0;
        }

        .map-tips-tooltip li::before {
            content: '\2022';
            color: #4ecdc4;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* ============================================================
           SIDEBAR TABS
           ============================================================ */
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-tab {
            flex: 1;
            padding: 14px 10px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .sidebar-tab:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
        }

        .sidebar-tab.active {
            color: #4ecdc4;
        }

        .sidebar-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 2px;
            background: #4ecdc4;
        }

        /* ============================================================
           SIDEBAR CONTENT
           ============================================================ */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* ============================================================
           ALL SPECIES TOGGLE
           ============================================================ */
        .all-species-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
        }

        .all-species-label {
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ============================================================
           TOGGLE SWITCH STYLES
           ============================================================ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 24px;
            transition: 0.3s;
            background: transparent;
            border: 2px solid var(--species-color, #4ecdc4);
            opacity: 0.5;
        }

        .toggle-slider::before {
            position: absolute;
            content: '';
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background: var(--species-color, #4ecdc4);
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--species-color, #4ecdc4);
            border-color: var(--species-color, #4ecdc4);
            opacity: 1;
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(20px);
            background: #fff;
        }

        /* ============================================================
           WHALE SPECIES CARDS
           ============================================================ */
        .species-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .species-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .species-card:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .species-card.expanded {
            box-shadow: 0 0 25px var(--species-color, #4ecdc4);
            background: rgba(255, 255, 255, 0.1);
        }

        .species-card-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            gap: 12px;
        }

        .header-toggle {
            flex-shrink: 0;
        }

        .header-toggle .toggle-switch {
            width: 40px;
            height: 22px;
        }

        .header-toggle .toggle-slider::before {
            height: 14px;
            width: 14px;
        }

        .header-toggle input:checked + .toggle-slider::before {
            transform: translateX(18px);
        }

        .species-name-collapsed {
            flex: 1;
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .species-card.expanded .species-name-collapsed {
            display: none;
        }

        .species-expand-btn {
            position: relative;
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .species-expand-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .species-expand-btn svg {
            width: 14px;
            height: 14px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .species-expand-btn .icon-plus { display: block; }
        .species-expand-btn .icon-minus { display: none; }
        .species-card.expanded .species-expand-btn { display: none; }

        .species-card-body {
            display: none;
            position: relative;
        }

        .species-card.expanded .species-card-body {
            display: block;
        }

        .species-collapse-btn {
            position: absolute;
            top: -40px;
            right: 16px;
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .species-collapse-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .species-collapse-btn svg {
            width: 14px;
            height: 14px;
        }

        .species-card-content {
            padding: 0 16px 10px;
            position: relative;
        }

        .species-image-area {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            height: 80px;
            margin-bottom: -50px;
            position: relative;
            z-index: 0;
            overflow: visible;
            padding-top: 0;
        }

        .species-image {
            max-width: 110%;
            max-height: 280px;
            object-fit: contain;
            filter: drop-shadow(0 4px 16px rgba(0, 0, 0, 0.5));
            margin-top: -100px;
        }

        .species-image-placeholder {
            color: rgba(255, 255, 255, 0.3);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .species-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
            position: relative;
            z-index: 1;
            padding-top: 40px;
        }

        .species-info-text {
            flex: 1;
        }

        .species-name-expanded {
            font-family: 'Oswald', sans-serif;
            font-size: 22px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            line-height: 1;
            margin-bottom: 2px;
        }

        .species-scientific {
            font-size: 11px;
            font-style: italic;
            color: #4ecdc4;
        }

        .species-info-btn {
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            text-decoration: none;
        }

        .species-info-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }


        /* ============================================================
           ANIMATION TAB CONTENT
           ============================================================ */
        .animation-section {
            margin-bottom: 24px;
        }

        .animation-section-title {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
        }

        .setting-group {
            margin-bottom: 16px;
        }

        .setting-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .setting-label span {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        .setting-value {
            font-size: 13px;
            font-weight: 600;
            color: #4ecdc4;
        }

        .setting-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            cursor: pointer;
        }

        .setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .setting-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            border: none;
        }

        .setting-description {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 6px;
        }

        .speed-presets {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .speed-preset-btn {
            flex: 1;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .speed-preset-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .speed-preset-btn.active {
            background: #4ecdc4;
            border-color: #4ecdc4;
            color: #0a2342;
        }

        .reset-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
        }

        .reset-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        /* ============================================================
           PRESETS TAB CONTENT
           ============================================================ */
        .preset-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .preset-card {
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .preset-card.active {
            background: rgba(78, 205, 196, 0.15);
            border-color: #4ecdc4;
        }

        .preset-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .preset-card-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .preset-utilities {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .preset-utility-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-utility-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* ============================================================
           MAP CONTROLS
           ============================================================ */
        .map-controls {
            position: fixed;
            right: 20px;
            top: 100px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 40;
        }

        .map-control-btn {
            width: 44px;
            height: 44px;
            background: rgba(10, 35, 66, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .map-control-btn:hover {
            background: rgba(20, 50, 90, 0.95);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .map-control-btn.active {
            background: #4ecdc4;
            border-color: #4ecdc4;
            color: #0a2342;
        }

        .map-control-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Projection Toggle - centered in map area */
        .projection-toggle {
            position: fixed;
            top: 100px;
            /* Center in map area: sidebar(380) + half of remaining space */
            left: calc(380px + (100vw - 380px) / 2);
            transform: translateX(-50%);
            display: flex;
            background: rgba(10, 35, 66, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            overflow: hidden;
            z-index: 40;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .projection-btn {
            padding: 10px 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .projection-btn:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .projection-btn.active {
            background: #1a6db0;
            color: #fff;
        }

        /* ============================================================
           BASEMAP CONTROLS - TOP LEFT OF MAP
           ============================================================ */
        .basemap-panel {
            position: fixed;
            top: 100px;
            left: calc(380px + 16px);
            z-index: 40;
        }

        .basemap-control-group {
            background: rgba(10, 35, 66, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 8px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .basemap-control-label {
            font-size: 9px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            text-align: center;
        }

        .basemap-toggle {
            display: flex;
            gap: 4px;
        }

        .basemap-btn {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(26, 109, 176, 0.25);
            font-size: 9px;
            font-weight: 600;
            color: #d9ecff;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .basemap-btn:hover {
            border-color: #4ecdc4;
            background: rgba(26, 109, 176, 0.55);
            color: #ffffff;
        }

        .basemap-btn.active {
            border-color: #4ecdc4;
            background: #1a6db0;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .basemap-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Mobile basemap select in settings panel */
        .mobile-basemap-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-basemap-select {
            width: 100%;
            padding: 6px 16px 6px 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 24 24' fill='none' stroke='%23d9ecff' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 8px center;
            font-size: 11px;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            min-width: 70px;
        }

        .mobile-basemap-select:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.25);
        }

        .mobile-basemap-select option {
            background: #0a2342;
            color: #fff;
        }

        /* Month Slider */
        /* Use :not(.controls-bottom-left) to match specificity of styles.css */
        #controls:not(.controls-bottom-left) {
            /* Override global #controls rules from styles.css that use !important */
            position: absolute !important;
            top: 630px !important;
            right: 5px !important;
            bottom: auto !important;
            left: auto !important;
            transform: none !important;
            z-index: 1300 !important; /* Sit above nav and mobile layers */
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            padding: 0 !important;
            backdrop-filter: none !important;
            width: fit-content !important;
        }

        /* Month slider theming */
        .month-wheel {
            background: radial-gradient(circle at 30% 30%, rgba(78, 205, 196, 0.15), rgba(10, 35, 66, 0.85));
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .month-marker {
            color: #d9ecff;
        }

        .month-marker:hover {
            color: #4ecdc4;
        }

        .month-marker.active {
            background: #1a6db0;
            color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.35);
        }

        .center-display {
            background: rgba(10, 35, 66, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.15);
        }

        .center-month {
            color: #d9ecff;
        }

        .center-play-icon {
            color: #4ecdc4;
        }

        /* ============================================================
           MOBILE FLOATING BUTTONS
           ============================================================ */
        .mobile-floating-btn {
            display: none;
            position: absolute;
            top: 15px !important;
            width: 44px;
            height: 44px;
            background: rgba(10, 35, 66, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            z-index: 1300;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .mobile-floating-btn:hover {
            background: rgba(20, 50, 90, 0.95);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .mobile-floating-btn.active {
            background: #4ecdc4;
            border-color: #4ecdc4;
            color: #0a2342;
        }

        .mobile-floating-btn svg {
            width: 22px;
            height: 22px;
        }

        .mobile-info-btn {
            left: 12px;
        }

        .mobile-anim-btn {
            right: 12px;
        }

        /* Mobile Floating Dropdown Panels */
        .mobile-floating-panel {
            display: none;
            position: absolute;
            top: 70px;
            width: calc(100% - 24px);
            max-width: 320px;
            max-height: 60vh;
            background: rgba(10, 35, 66, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 16px;
            z-index: 1250;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .mobile-floating-panel.open {
            display: block;
        }

        .mobile-info-panel {
            left: 12px;
        }

        .mobile-anim-panel {
            right: 12px;
        }

        .mobile-panel-title {
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-panel-desc {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .mobile-panel-tips {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .mobile-panel-tips li {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .mobile-panel-tips li::before {
            content: '\2022';
            color: #4ecdc4;
            font-weight: bold;
            flex-shrink: 0;
        }

        .mobile-anim-section {
            margin-bottom: 20px;
        }

        .mobile-anim-section:last-child {
            margin-bottom: 0;
        }

        .mobile-anim-section-title {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }

        .mobile-anim-speed-btns {
            display: flex;
            gap: 8px;
        }

        .mobile-anim-speed-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mobile-anim-speed-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .mobile-anim-speed-btn.active {
            background: #4ecdc4;
            border-color: #4ecdc4;
            color: #0a2342;
        }

        .mobile-anim-slider-group {
            margin-bottom: 16px;
        }

        .mobile-anim-slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .mobile-anim-slider-label .value {
            color: #4ecdc4;
            font-weight: 600;
        }

        .mobile-anim-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .mobile-anim-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .mobile-anim-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            border: none;
        }

        /* ============================================================
           MOBILE STYLES
           ============================================================ */
        .mobile-species-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 160px;
            background: rgba(10, 35, 66, 0.98);
            backdrop-filter: blur(10px);
            z-index: 500;
            padding: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-species-bar::-webkit-scrollbar {
            display: none;
        }

        .mobile-species-cards {
            display: flex;
            gap: 12px;
            height: 100%;
        }

        .mobile-species-card {
            flex-shrink: 0;
            width: calc(50vw - 24px);
            min-width: 160px;
            max-width: 200px;
            height: 100%;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: default;
            transition: all 0.2s;
            text-align: center;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .mobile-species-card:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .mobile-species-card .mobile-toggle {
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
        }

        .mobile-species-card .mobile-toggle .toggle-switch {
            width: 36px;
            height: 20px;
        }

        .mobile-species-card .mobile-toggle .toggle-slider::before {
            height: 12px;
            width: 12px;
        }

        .mobile-species-card .mobile-toggle input:checked + .toggle-slider::before {
            transform: translateX(16px);
        }

        .mobile-species-card .mobile-info-btn {
            position: absolute;
            top: 8px;
            left: auto;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
        }

        .mobile-species-card .mobile-info-btn:hover {
            background: rgba(78, 205, 196, 0.3);
            border-color: #4ecdc4;
        }

        .mobile-species-card img {
            width: 200% !important;
            height: 135px !important;
            object-fit: contain;
            margin-top: -35px !important;
            margin-bottom: -25px !important;
        }

        .mobile-species-card .species-name {
            font-family: 'Oswald', sans-serif;
            font-size: 13px !important;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            line-height: 1.2;
        }

        /* ============================================================
           RESPONSIVE
           ============================================================ */
        @media (max-width: 900px) {
            .sidebar {
                display: none;
            }

            .map-wrapper {
                left: 0 !important;
                right: 0 !important;
                top: var(--nav-height) !important;
                bottom: 180px;
                margin: 0 !important;
                padding: 0 !important;
            }

            #map {
                left: 0 !important;
                right: 0 !important;
                top: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .mobile-species-bar {
                display: block;
                height: 160px;
            }

            .mobile-bottom-sheet {
                display: block;
            }

            .mobile-floating-btn {
                display: flex;
            }

            .projection-toggle {
                left: 50%;
                top: var(--mobile-ctrl-top);
            }

            /* Hide desktop basemap panel on mobile */
            .basemap-panel {
                display: none;
            }

            /* Month slider - uses CSS variables for easy adjustment */
            /* Use :not(.controls-bottom-left) to match specificity of styles.css */
            #controls:not(.controls-bottom-left) {
                position: absolute !important;
                top: auto !important;
                left: auto !important;
                right: 0 !important;
                bottom: var(--slider-bottom) !important;
                transform: none !important;
                z-index: 1300 !important;
            }

            .map-controls {
                display: none;
            }
        }

        @media (max-width: 600px) {
            .projection-btn {
                padding: 8px 12px;
                font-size: 10px;
            }

            .mobile-floating-btn {
                top: var(--mobile-ctrl-top);
                width: 40px;
                height: 40px;
            }

            .mobile-floating-btn svg {
                width: 20px;
                height: 20px;
            }

            .mobile-floating-panel {
                top: 70px;
            }

            .map-wrapper {
                left: 0 !important;
                right: 0 !important;
                bottom: 165px;
            }

            /* Smaller mobile species bar */
            .mobile-species-bar {
                height: 145px;
                padding: 10px;
            }

            /* Slider position for 600px - direct override */
            #controls:not(.controls-bottom-left) {
                left: auto !important;
                right: -15px !important;
                bottom: 15px !important;
            }

            .mobile-species-card {
                width: calc(50vw - 20px);
                min-width: 140px;
            }

            /* Image size controlled by base .mobile-species-card img styles */

            .mobile-species-card .species-name {
                font-size: 11px;
            }
        }

        @media (max-width: 400px) {
            .map-wrapper {
                left: 0 !important;
                right: 0 !important;
                bottom: 150px;
            }

            .mobile-species-bar {
                height: 130px;
            }

            /* Slider position for 400px - direct override */
            #controls:not(.controls-bottom-left) {
                left: auto !important;
                right: 0 !important;
                bottom: 15px !important;
            }

            .mobile-species-card {
                min-width: 150px;
            }

            /* Image size controlled by base .mobile-species-card img styles */

            .mobile-floating-panel {
                max-height: 50vh;
            }
        }

        /* Hide mapbox logo and attribution */
        .mapboxgl-ctrl-logo,
        .mapboxgl-ctrl-attrib {
            display: none !important;
        }

        /* Mapbox navigation controls styling */
        .mapboxgl-ctrl-group {
            background: rgba(10, 35, 66, 0.9) !important;
            border-radius: 8px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .mapboxgl-ctrl-group button {
            background-color: transparent !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        .mapboxgl-ctrl-group button + button {
            border-top-color: rgba(255, 255, 255, 0.1) !important;
        }

        .mapboxgl-ctrl-icon {
            filter: invert(1);
        }

        /* ============================================================
           LOADING ANIMATION OVERLAY
           ============================================================ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            z-index: 900;
            background: #0e2c4b;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-overlay video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transform: scale(1.1);
        }

        /* Desktop: smaller centered video */
        @media (min-width: 768px) {
            .loading-overlay video {
                max-width: 50%;
                max-height: 60%;
            }
        }

        @media (min-width: 1200px) {
            .loading-overlay video {
                max-width: 40%;
                max-height: 50%;
            }
        }

        /* ============================================================
           WELCOME MODAL - Map Usage Instructions
           ============================================================ */
        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            z-index: 800;
            background: rgba(10, 22, 40, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }

        .welcome-modal.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .welcome-content {
            background: linear-gradient(135deg, #0f2d4a 0%, #1a4a6e 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 24px;
            max-width: 420px;
            width: 90%;
            max-height: 78vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .welcome-header h2 {
            color: #fff;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .welcome-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .welcome-tips {
            margin-bottom: 24px;
        }

        .welcome-tip {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .welcome-tip:last-child {
            border-bottom: none;
        }

        .tip-icon {
            width: 36px;
            height: 36px;
            background: rgba(78, 205, 196, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
        }

        .tip-text {
            flex: 1;
        }

        .tip-text h4 {
            color: #4ecdc4;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tip-text p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            line-height: 1.4;
        }

        .welcome-footer {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .welcome-btn {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a8a0 100%);
            color: #0a1628;
            border: none;
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .welcome-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(78, 205, 196, 0.3);
        }

        .welcome-btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .welcome-loading {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .welcome-loading.ready {
            color: #4ecdc4;
        }

        .loading-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: #4ecdc4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .welcome-loading.ready .loading-spinner {
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile adjustments */
        @media (max-width: 600px) {
            .welcome-modal {
                align-items: flex-start;
                padding-top: 15vh;
            }

            .welcome-content {
                padding: 16px;
                margin: 12px;
                max-width: 320px;
                max-height: 60vh;
            }

            .welcome-header h2 {
                font-size: 18px;
            }

            .welcome-header p {
                font-size: 12px;
            }

            .tip-icon {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .tip-text h4 {
                font-size: 12px;
            }

            .tip-text p {
                font-size: 11px;
            }

            .welcome-btn {
                padding: 12px 24px;
                font-size: 13px;
            }

            .welcome-tip {
                padding: 8px 0;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Animation Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <video id="loadingVideo" autoplay muted playsinline>
            <source src="models/animation_video.webm" type="video/webm">
        </video>
    </div>

    <!-- Welcome Modal - Map Usage Instructions -->
    <div class="welcome-modal" id="welcomeModal">
        <div class="welcome-content">
            <div class="welcome-header">
                <h2>Species Distribution Map</h2>
                <p>Explore whale migration patterns throughout the year</p>
            </div>
            <div class="welcome-tips">
                <div class="welcome-tip">
                    <div class="tip-icon"></div>
                    <div class="tip-text">
                        <h4>Select Species</h4>
                        <p>Toggle whale species on/off using the sidebar panel or mobile species bar at the bottom.</p>
                    </div>
                </div>
                <div class="welcome-tip">
                    <div class="tip-icon"></div>
                    <div class="tip-text">
                        <h4>Monthly Animation</h4>
                        <p>Use the circular dial to scrub through months or press play to animate seasonal migrations.</p>
                    </div>
                </div>
                <div class="welcome-tip">
                    <div class="tip-icon"></div>
                    <div class="tip-text">
                        <h4>Navigate the Globe</h4>
                        <p>Click and drag to rotate. Scroll or pinch to zoom. Double-click to zoom in on an area.</p>
                    </div>
                </div>
                <div class="welcome-tip">
                    <div class="tip-icon"></div>
                    <div class="tip-text">
                        <h4>Regional Presets</h4>
                        <p>Jump to specific ocean regions using the preset buttons in the controls panel.</p>
                    </div>
                </div>
            </div>
            <div class="welcome-footer">
                <button class="welcome-btn" id="welcomeBtn" disabled>Loading map...</button>
                <div class="welcome-loading" id="welcomeLoading">
                    <div class="loading-spinner"></div>
                    <span>Preparing map data...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav id="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <span class="whale-icon">
                    <img src="favicon.ico" alt="Whale Icon" class="whale-icon-img">
                </span>
                <span class="brand-text">Whale Watchers Atlas</span>
            </a>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-links">
                <a href="density-map.html" class="nav-link">Density Map</a>
                <a href="species.html" class="nav-link active">Species Map</a>
                <a href="whale-species-gallery.html" class="nav-link">Whale Species</a>
                <a href="whale-locations-gallery.html" class="nav-link">Locations</a>
                <a href="about.html" class="nav-link">About</a>
            </div>
        </div>
    </nav>

    <!-- Fixed Sidebar Panel -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1 class="sidebar-title">Species Migration Tracker</h1>
            <!-- <div class="sidebar-stats">
                <div class="sidebar-stat">
                    <div class="sidebar-stat-value">11</div>
                    <div class="sidebar-stat-label">Species</div>
                </div>
                <div class="sidebar-stat">
                    <div class="sidebar-stat-value">30</div>
                    <div class="sidebar-stat-label">Years of Data</div>
                </div>
            </div> -->
            <p class="sidebar-description">Explore how whale species move across oceans throughout the year. Toggle species to see their migration patterns.<br><br>
                The species-specific density maps are generated from local observations across the world, over the past 30 years. The up-to-date species observations 
                can be found at the whale and location specific galleries.
            </p>
            <button class="map-tips-btn" id="mapTipsBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4M12 8h.01"/>
                </svg>
                Map Tips
            </button>
            <div class="map-tips-tooltip" id="mapTipsTooltip">
                <ul>
                    <li>Data resolution decreases as you zoom out - zoom in for more detail</li>
                    <li>Use the Animation tab to adjust playback speed and animation style</li>
                    <li>Try the Presets tab for curated migration journeys by ocean region</li>
                    <li>Toggle multiple species to compare migration patterns</li>
                    <li>Switch between Globe and Flat views for different perspectives</li>
                </ul>
            </div>
        </div>

        <div class="sidebar-tabs">
            <button class="sidebar-tab active" data-tab="species">Whale Species</button>
            <button class="sidebar-tab" data-tab="animation">Animation</button>
            <button class="sidebar-tab" data-tab="presets">Presets</button>
        </div>

        <div class="sidebar-content">
            <!-- Species Tab -->
            <div class="tab-panel active" id="tab-species">
                <div class="all-species-toggle" style="--species-color: #4ecdc4;">
                    <span class="all-species-label">All Species</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="allSpeciesToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="species-list" id="speciesList">
                    <!-- Species cards generated by JavaScript -->
                </div>
            </div>

            <!-- Animation Tab -->
            <div class="tab-panel" id="tab-animation">
                <div class="animation-section">
                    <div class="animation-section-title">Playback Controls</div>
                    <div class="setting-group">
                        <div class="setting-label">
                            <span>Transition Speed</span>
                            <span class="setting-value" id="speedValue">1.0s</span>
                        </div>
                        <input type="range" class="setting-slider" id="speedSlider" min="200" max="3000" value="1000" step="100">
                        <div class="setting-description">Time to transition between months</div>
                        <div class="speed-presets">
                            <button class="speed-preset-btn" data-speed="400">Fast</button>
                            <button class="speed-preset-btn active" data-speed="1000">Normal</button>
                            <button class="speed-preset-btn" data-speed="2000">Slow</button>
                        </div>
                    </div>
                </div>

                <div class="animation-section">
                    <div class="animation-section-title">Heatmap Settings</div>
                    <div class="setting-group">
                        <div class="setting-label">
                            <span>Intensity</span>
                            <span class="setting-value" id="intensityValue">100%</span>
                        </div>
                        <input type="range" class="setting-slider" id="intensitySlider" min="20" max="200" value="100" step="10">
                        <div class="setting-description">Brightness of species density overlay</div>
                    </div>

                    <div class="setting-group">
                        <div class="setting-label">
                            <span>Radius</span>
                            <span class="setting-value" id="radiusValue">100%</span>
                        </div>
                        <input type="range" class="setting-slider" id="radiusSlider" min="50" max="200" value="100" step="10">
                        <div class="setting-description">Spread of each data point</div>
                    </div>
                </div>

                <button class="reset-btn" id="resetSettings">Reset to Defaults</button>
            </div>

            <!-- Presets Tab -->
            <div class="tab-panel" id="tab-presets">
                <div class="preset-utilities">
                    <button class="preset-utility-btn" data-preset="clear">Clear All</button>
                    <button class="preset-utility-btn" data-preset="all">All Species</button>
                </div>
                <div class="preset-list">
                    <div class="preset-card" data-preset="north_pacific">
                        <div class="preset-card-title">North Pacific Migration</div>
                        <div class="preset-card-desc">Blue, Humpback, Gray Whales</div>
                    </div>
                    <div class="preset-card" data-preset="north_atlantic">
                        <div class="preset-card-title">North Atlantic</div>
                        <div class="preset-card-desc">Humpback, Fin, Right Whale, Minke, Sei</div>
                    </div>
                    <div class="preset-card" data-preset="arctic">
                        <div class="preset-card-title">North Arctic</div>
                        <div class="preset-card-desc">Beluga, Orca (Northern)</div>
                    </div>
                    <div class="preset-card" data-preset="southern_ocean">
                        <div class="preset-card-title">Southern Ocean</div>
                        <div class="preset-card-desc">Blue, Humpback, Orca, Southern Right</div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Map Area -->
    <div class="map-wrapper" id="mapWrapper">
        <div id="map"></div>
        <!-- Month Slider -->
        <div id="controls"></div>

        <!-- Mobile Floating Info Button -->
        <button class="mobile-floating-btn mobile-info-btn" id="mobileInfoBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
            </svg>
        </button>

        <!-- Mobile Info Panel -->
        <div class="mobile-floating-panel mobile-info-panel" id="mobileInfoPanel">
            <div class="mobile-panel-title">Species Migration Tracker</div>
            <p class="mobile-panel-desc">Explore how whale species move across oceans throughout the year. Toggle species to see their migration patterns.<br><br>
                The species-specific density maps are generated from local observations across the world, over the past 30 years. The up-to-date species observations 
                can be found at the whale and location specific galleries.</p>

            <div class="mobile-anim-section">
                <div class="mobile-anim-section-title">Map Navigation</div>
                <p style="font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; margin: 0;">Data resolution decreases as you zoom out - zoom in for more detail. Switch between Globe and Flat views for different perspectives.</p>
            </div>

            <div class="mobile-anim-section">
                <div class="mobile-anim-section-title">Species Selection</div>
                <p style="font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; margin: 0;">Tap multiple species to compare migration patterns. Use the Animation settings to adjust playback speed.</p>
            </div>

            <div class="mobile-anim-section" style="margin-bottom: 0;">
                <div class="mobile-anim-section-title">Raw Data</div>
                <p style="font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; margin: 0;">Visit the species detail page to view individual sighting data points on an interactive map.</p>
            </div>
        </div>

        <!-- Mobile Floating Animation Button -->
        <button class="mobile-floating-btn mobile-anim-btn" id="mobileAnimBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
        </button>

        <!-- Mobile Animation Panel -->
        <div class="mobile-floating-panel mobile-anim-panel" id="mobileAnimPanel">
            <div class="mobile-panel-title">Animation Settings</div>

            <div class="mobile-anim-section">
                <div class="mobile-anim-section-title">Playback Speed</div>
                <div class="mobile-anim-speed-btns">
                    <button class="mobile-anim-speed-btn" data-speed="400">Fast</button>
                    <button class="mobile-anim-speed-btn active" data-speed="1000">Normal</button>
                    <button class="mobile-anim-speed-btn" data-speed="2000">Slow</button>
                </div>
            </div>

            <div class="mobile-anim-section">
                <div class="mobile-anim-section-title">Heatmap Settings</div>
                <div class="mobile-anim-slider-group">
                    <div class="mobile-anim-slider-label">
                        <span>Intensity</span>
                        <span class="value" id="mobileAnimIntensityVal">100%</span>
                    </div>
                    <input type="range" class="mobile-anim-slider" id="mobileAnimIntensitySlider" min="20" max="200" value="100" step="10">
                </div>
                <div class="mobile-anim-slider-group">
                    <div class="mobile-anim-slider-label">
                        <span>Radius</span>
                        <span class="value" id="mobileAnimRadiusVal">100%</span>
                    </div>
                    <input type="range" class="mobile-anim-slider" id="mobileAnimRadiusSlider" min="50" max="200" value="100" step="10">
                </div>
            </div>

            <div class="mobile-basemap-section">
                <div class="mobile-anim-section-title">Basemap</div>
                <select class="mobile-basemap-select" id="mobileBasemapSelect">
                    <option value="satellite">Satellite</option>
                    <option value="bathymetry">Ocean</option>
                    <option value="custom" selected>Terrain</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Projection Toggle -->
    <div class="projection-toggle">
        <button class="projection-btn active" data-projection="globe">Globe</button>
        <button class="projection-btn" data-projection="mercator">Flat</button>
    </div>

    <!-- Basemap Panel - Top Left -->
    <div class="basemap-panel">
        <div class="basemap-control-group">
            <div class="basemap-control-label">Basemap</div>
            <div class="basemap-toggle">
                <button class="basemap-btn" data-basemap="satellite" title="Satellite">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                    </svg>
                    Satellite
                </button>
                <button class="basemap-btn" data-basemap="bathymetry" title="Bathymetry">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M2 12c2-3 4-4 6-4s4 2 6 2 4-2 6-2 4 1 4 4"/>
                        <path d="M2 16c2-2 4-3 6-3s4 1.5 6 1.5 4-1.5 6-1.5 4 1 4 3"/>
                        <path d="M2 8c2-2 4-3 6-3s4 1 6 1 4-1 6-1"/>
                    </svg>
                    Ocean
                </button>
                <button class="basemap-btn active" data-basemap="custom" title="Custom Style">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    Terrain
                </button>
            </div>
        </div>
    </div>

    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" id="fullscreenBtn" title="Toggle Fullscreen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
            </svg>
        </button>
    </div>

    <!-- Mobile Species Bar -->
    <div class="mobile-species-bar">
        <div class="mobile-species-cards" id="mobileSpeciesCards"></div>
    </div>

    <!-- Scripts -->
    <script src="whale-species.js"></script>
    <script src="config.js"></script>
    <script src="circular-controls.js"></script>

    <script>
    // ============================================================
    // SPECIES MAP - Main Script
    // ============================================================

    // Get whale image by species ID
    function getWhaleImage(speciesId) {
        const imageMap = {
            'blue_whale_heat': 'images/whales/assets/Blue_whale.png',
            'humpback_whale_heat': 'images/whales/assets/Humpback_whale.png',
            'sperm_whale_heat': 'images/whales/assets/Sperm_whale.png',
            'beluga_heat': 'images/whales/assets/Beluga_whale.png',
            'gray_whale_heat': 'images/whales/assets/Gray_whale.png',
            'minke_heat': 'images/whales/assets/Minke_whale.png',
            'north_atlantic_right_whale_heat': 'images/whales/assets/NorthAtlanticRight_whale.png',
            'southern_right_whale_heat': 'images/whales/assets/SouthernRight_whale.png',
            'fin_whale_heat': 'images/whales/assets/Fin_whale.png',
            'sei_whale_heat': 'images/whales/assets/Sei_whale.png',
            'orca_whale_heat': 'images/whales/assets/Orca_whale.png'
        };
        return imageMap[speciesId] || null;
    }

    function getWhaleData(commonName) {
        return WHALE_SPECIES.find(w => w.commonName === commonName);
    }

    function setupNavToggle() {
        const navbar = document.getElementById('navbar');
        const toggle = document.getElementById('navToggle');
        if (!navbar || !toggle) return;

        toggle.addEventListener('click', () => {
            navbar.classList.toggle('nav-open');
        });

        navbar.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => navbar.classList.remove('nav-open'));
        });
    }

    // ============================================================
    // MAP INITIALIZATION
    // ============================================================
    mapboxgl.accessToken = MAPBOX_TOKEN;

    // Basemap styles
    const BASEMAP_STYLES = {
        satellite: 'mapbox://styles/mapbox/satellite-v9',
        custom: 'mapbox://styles/qtyree/cmkq3f00c003001qs2qib3wlr'
    };

    // Check if mobile
    const isMobile = window.innerWidth <= 900;

    const map = new mapboxgl.Map({
        container: 'map',
        style: BASEMAP_STYLES.custom, // Default to terrain
        center: [-98, 39],
        zoom: isMobile ? 2 : 2,
        projection: 'globe'
    });

    map.addControl(new mapboxgl.NavigationControl({ showCompass: false }), 'bottom-left');

    map.on('style.load', () => {
        map.setFog({
            color: 'rgb(10, 35, 66)',
            'high-color': 'rgb(20, 50, 90)',
            'horizon-blend': 0.1,
            'space-color': 'rgb(5, 15, 30)',
            'star-intensity': 0.3
        });
    });

    // ============================================================
    // STATE
    // ============================================================
    let monthA = 1, monthB = 2;
    let phase = 0;
    let isPlaying = false;
    let animationId = null;
    let lastTime = 0;
    let morphDuration = 1000;
    let intensityMultiplier = 1;
    let radiusMultiplier = 1;
    let circularControls = null;
    let activePreset = null;
    let allSpeciesOn = false;
    let currentBasemap = 'custom';

    // ============================================================
    // BASEMAP SWITCHING
    // ============================================================
    function setBathymetryLayer(show) {
        const layerId = 'bathymetry-layer';
        if (show) {
            if (!map.getSource('bathymetry-source')) {
                map.addSource('bathymetry-source', {
                    type: 'raster',
                    tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}'],
                    tileSize: 256
                });
            }
            if (!map.getLayer(layerId)) {
                const firstSymbolLayer = map.getStyle().layers.find(l => l.type === 'symbol');
                map.addLayer({
                    id: layerId,
                    type: 'raster',
                    source: 'bathymetry-source',
                    paint: { 'raster-opacity': 0.85 }
                }, firstSymbolLayer ? firstSymbolLayer.id : undefined);
            } else {
                map.setLayoutProperty(layerId, 'visibility', 'visible');
            }
        } else {
            if (map.getLayer(layerId)) {
                map.setLayoutProperty(layerId, 'visibility', 'none');
            }
        }
    }

    function getVisibleSpecies() {
        // Get currently visible species from checkbox states
        const visible = [];
        document.querySelectorAll('.species-toggle-checkbox').forEach(cb => {
            if (cb.checked) visible.push(cb.dataset.species);
        });
        return visible;
    }

    function restoreSpeciesVisibility(visibleSpecies) {
        // Restore visibility for all species based on saved state
        SPECIES_CONFIG.forEach(species => {
            const isVisible = visibleSpecies.includes(species.id);
            if (map.getLayer(species.id)) {
                map.setLayoutProperty(species.id, 'visibility', isVisible ? 'visible' : 'none');
            }
        });
        // Restore paint properties
        applyIntensityAll();
        applyRadiusAll();
        setFilterAll();
        setWeightAll(phase);
    }

    function switchBasemap(basemap) {
        if (basemap === currentBasemap) return;

        const prevBasemap = currentBasemap;
        currentBasemap = basemap;

        // Save current visibility state before switching
        const visibleSpecies = getVisibleSpecies();

        if (basemap === 'bathymetry') {
            if (prevBasemap === 'custom') {
                map.setStyle(BASEMAP_STYLES.satellite);
                map.once('style.load', () => {
                    addSpeciesLayers();
                    restoreSpeciesVisibility(visibleSpecies);
                    setBathymetryLayer(true);
                });
            } else {
                setBathymetryLayer(true);
            }
        } else if (basemap === 'satellite') {
            if (prevBasemap === 'custom') {
                map.setStyle(BASEMAP_STYLES.satellite);
                map.once('style.load', () => {
                    addSpeciesLayers();
                    restoreSpeciesVisibility(visibleSpecies);
                });
            } else {
                setBathymetryLayer(false);
            }
        } else if (basemap === 'custom') {
            setBathymetryLayer(false);
            map.setStyle(BASEMAP_STYLES.custom);
            map.once('style.load', () => {
                addSpeciesLayers();
                restoreSpeciesVisibility(visibleSpecies);
            });
        }
    }

    // ============================================================
    // SPECIES LAYER MANAGEMENT
    // ============================================================
    function addSpeciesLayers() {
        SPECIES_CONFIG.forEach(species => {
            if (!map.getSource(species.sourceId)) {
                map.addSource(species.sourceId, { type: 'vector', url: species.url });
            }

            const isBlueWhale = species.id.includes('blue');
            if (!map.getLayer(species.id)) {
                map.addLayer({
                    id: species.id,
                    type: 'heatmap',
                    source: species.sourceId,
                    'source-layer': species.sourceLayer,
                    maxzoom: 9,
                    layout: { visibility: isBlueWhale ? 'visible' : 'none' },
                    paint: { ...HEATMAP_PAINT_BASE, 'heatmap-color': species.color.heatmap }
                });
            }
        });
        setFilterAll();
        setWeightAll(0);
    }

    function setFilterAll() {
        SPECIES_CONFIG.forEach(species => {
            if (map.getLayer(species.id)) {
                map.setFilter(species.id, ['in', ['get', 'month'], ['literal', [monthA, monthB]]]);
            }
        });
    }

    function setWeightAll(phaseVal) {
        const presetFilters = window.getActivePresetFilters ? window.getActivePresetFilters() : null;

        SPECIES_CONFIG.forEach(species => {
            if (!map.getLayer(species.id)) return;

            let oceanList = null;
            if (presetFilters) {
                for (const [key, oceans] of Object.entries(presetFilters)) {
                    if (species.id.toLowerCase().includes(key.toLowerCase())) {
                        oceanList = oceans;
                        break;
                    }
                }
            }

            const monthWeight = [
                'case',
                ['==', ['get', 'month'], monthA], 1 - phaseVal,
                ['==', ['get', 'month'], monthB], phaseVal,
                0
            ];

            const weightExpr = oceanList
                ? ['case', ['in', ['get', 'ocean'], ['literal', oceanList]], monthWeight, 0]
                : monthWeight;

            map.setPaintProperty(species.id, 'heatmap-weight', weightExpr);
        });
    }

    function applyIntensityAll() {
        SPECIES_CONFIG.forEach(species => {
            if (!map.getLayer(species.id)) return;
            map.setPaintProperty(species.id, 'heatmap-intensity', [
                'interpolate', ['linear'], ['zoom'],
                0, 0.5 * intensityMultiplier,
                5, 1.0 * intensityMultiplier,
                8, 1.5 * intensityMultiplier
            ]);
        });
    }

    function applyRadiusAll() {
        SPECIES_CONFIG.forEach(species => {
            if (!map.getLayer(species.id)) return;
            map.setPaintProperty(species.id, 'heatmap-radius', [
                'interpolate', ['linear'], ['zoom'],
                0, 2 * radiusMultiplier,
                4, 12 * radiusMultiplier,
                8, 24 * radiusMultiplier
            ]);
        });
    }

    function toggleSpeciesVisibility(speciesId, visible) {
        if (map.getLayer(speciesId)) {
            map.setLayoutProperty(speciesId, 'visibility', visible ? 'visible' : 'none');
        }
    }

    // ============================================================
    // ANIMATION
    // ============================================================
    function startAnimation() {
        if (isPlaying) return;
        isPlaying = true;
        lastTime = performance.now();
        animationId = requestAnimationFrame(stepAnimation);
        if (circularControls) circularControls.setPlaying(true);
    }

    function stopAnimation() {
        isPlaying = false;
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
        if (circularControls) circularControls.setPlaying(false);
    }

    function stepAnimation(timestamp) {
        if (!isPlaying) return;
        const delta = timestamp - lastTime;
        phase += delta / morphDuration;

        if (phase >= 1) {
            phase = 0;
            monthA = monthB;
            monthB = (monthB % 12) + 1;
            setFilterAll();
            if (circularControls) circularControls.externalSetMonth(monthA);
        }

        setWeightAll(phase);
        lastTime = timestamp;
        animationId = requestAnimationFrame(stepAnimation);
    }

    function setMonth(month) {
        stopAnimation();
        monthA = month;
        monthB = (month % 12) + 1;
        phase = 0;
        setFilterAll();
        setWeightAll(0);
        if (circularControls) circularControls.externalSetMonth(month);
    }

    // ============================================================
    // GENERATE SPECIES CARDS
    // ============================================================
    function generateSpeciesCards() {
        const container = document.getElementById('speciesList');
        const mobileContainer = document.getElementById('mobileSpeciesCards');
        if (!container) return;

        container.innerHTML = '';
        if (mobileContainer) mobileContainer.innerHTML = '';

        SPECIES_CONFIG.forEach(species => {
            const whaleData = getWhaleData(species.name);
            const image = getWhaleImage(species.id);
            const baseColor = species.color.base || '#4ecdc4';
            const isBlueWhale = species.id.includes('blue');

            // Desktop card
            const card = document.createElement('div');
            card.className = 'species-card';
            card.dataset.speciesId = species.id;
            card.style.setProperty('--species-color', baseColor);

            card.innerHTML = `
                <div class="species-card-header">
                    <div class="header-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" ${isBlueWhale ? 'checked' : ''} data-species="${species.id}">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <span class="species-name-collapsed">${species.name}</span>
                    <button class="species-expand-btn">
                        <svg class="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        <svg class="icon-minus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14"/>
                        </svg>
                    </button>
                </div>
                <div class="species-card-body">
                    <button class="species-collapse-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14"/>
                        </svg>
                    </button>
                    <div class="species-card-content">
                        <div class="species-image-area">
                            ${image ? `<img src="${image}" alt="${species.name}" class="species-image">` : '<span class="species-image-placeholder">Image coming soon</span>'}
                        </div>
                        <div class="species-info">
                            <div class="species-info-text">
                                <div class="species-name-expanded">${species.name}</div>
                                <div class="species-scientific">${species.scientificName || ''}</div>
                            </div>
                            ${whaleData ? `<a href="whale-detail.html?id=${whaleData.id}" class="species-info-btn" title="More info">i</a>` : ''}
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(card);

            // Event listeners
            const header = card.querySelector('.species-card-header');
            header.addEventListener('click', (e) => {
                if (e.target.closest('.header-toggle') || e.target.closest('.species-expand-btn')) return;
                card.classList.toggle('expanded');
            });

            card.querySelector('.species-expand-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                card.classList.toggle('expanded');
            });

            card.querySelector('.species-collapse-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                card.classList.remove('expanded');
            });

            const checkbox = card.querySelector('.header-toggle input[type="checkbox"]');
            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                toggleSpeciesVisibility(species.id, e.target.checked);
                syncMobileCheckbox(species.id, e.target.checked);
                updateAllSpeciesToggle();
            });

            // Mobile card
            if (mobileContainer) {
                const mobileCard = document.createElement('div');
                mobileCard.className = 'mobile-species-card';
                mobileCard.dataset.speciesId = species.id;
                mobileCard.style.setProperty('--species-color', baseColor);
                mobileCard.innerHTML = `
                    <div class="mobile-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" ${isBlueWhale ? 'checked' : ''} data-species="${species.id}">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    ${whaleData ? `<a href="whale-detail.html?id=${whaleData.id}" class="mobile-info-btn" title="More info">i</a>` : ''}
                    ${image ? `<img src="${image}" alt="${species.name}">` : ''}
                    <div class="species-name">${species.name}</div>
                `;

                mobileCard.querySelector('.mobile-toggle input').addEventListener('change', (e) => {
                    e.stopPropagation();
                    toggleSpeciesVisibility(species.id, e.target.checked);
                    syncDesktopCheckbox(species.id, e.target.checked);
                    updateAllSpeciesToggle();
                });

                mobileContainer.appendChild(mobileCard);
            }
        });
    }

    function syncMobileCheckbox(speciesId, checked) {
        const cb = document.querySelector(`.mobile-species-card[data-species-id="${speciesId}"] input`);
        if (cb) cb.checked = checked;
    }

    function syncDesktopCheckbox(speciesId, checked) {
        const cb = document.querySelector(`.species-card[data-species-id="${speciesId}"] input`);
        if (cb) cb.checked = checked;
    }

    function updateAllSpeciesToggle() {
        const checkboxes = document.querySelectorAll('#speciesList input[type="checkbox"]');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        const toggle = document.getElementById('allSpeciesToggle');
        if (toggle) toggle.checked = allChecked;
        allSpeciesOn = allChecked;
    }

    // ============================================================
    // ALL SPECIES TOGGLE
    // ============================================================
    function setupAllSpeciesToggle() {
        const toggle = document.getElementById('allSpeciesToggle');
        if (!toggle) return;

        toggle.addEventListener('change', (e) => {
            allSpeciesOn = e.target.checked;
            const checkboxes = document.querySelectorAll('#speciesList input[type="checkbox"]');

            checkboxes.forEach(cb => {
                cb.checked = allSpeciesOn;
                toggleSpeciesVisibility(cb.dataset.species, allSpeciesOn);
                syncMobileCheckbox(cb.dataset.species, allSpeciesOn);
            });

            setWeightAll(phase);
        });
    }

    // ============================================================
    // TABS
    // ============================================================
    function setupTabs() {
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(`tab-${tab.dataset.tab}`)?.classList.add('active');
            });
        });
    }

    // ============================================================
    // PROJECTION TOGGLE
    // ============================================================
    function setupProjectionToggle() {
        document.querySelectorAll('.projection-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.projection-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                map.setProjection(btn.dataset.projection);
            });
        });
    }

    // ============================================================
    // BASEMAP TOGGLE
    // ============================================================
    function setupBasemapToggle() {
        const basemapBtns = document.querySelectorAll('.basemap-btn');
        const mobileBasemapSelect = document.getElementById('mobileBasemapSelect');

        basemapBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const basemap = btn.dataset.basemap;
                basemapBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                switchBasemap(basemap);

                // Sync mobile select
                if (mobileBasemapSelect) {
                    mobileBasemapSelect.value = basemap;
                }
            });
        });

        if (mobileBasemapSelect) {
            mobileBasemapSelect.addEventListener('change', () => {
                const basemap = mobileBasemapSelect.value;
                switchBasemap(basemap);
                basemapBtns.forEach(b => b.classList.toggle('active', b.dataset.basemap === basemap));
            });
        }
    }

    // ============================================================
    // FULLSCREEN
    // ============================================================
    function setupFullscreen() {
        const btn = document.getElementById('fullscreenBtn');
        if (!btn) return;

        btn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                btn.classList.add('active');
            } else {
                document.exitFullscreen();
                btn.classList.remove('active');
            }
        });

        document.addEventListener('fullscreenchange', () => {
            btn.classList.toggle('active', !!document.fullscreenElement);
        });
    }

    // ============================================================
    // ANIMATION SETTINGS
    // ============================================================
    function setupAnimationSettings() {
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const speedPresets = document.querySelectorAll('.speed-preset-btn');

        if (speedSlider) {
            speedSlider.addEventListener('input', () => {
                morphDuration = parseInt(speedSlider.value);
                if (speedValue) speedValue.textContent = (morphDuration / 1000).toFixed(1) + 's';
                speedPresets.forEach(btn => btn.classList.toggle('active', parseInt(btn.dataset.speed) === morphDuration));
            });
        }

        speedPresets.forEach(btn => {
            btn.addEventListener('click', () => {
                morphDuration = parseInt(btn.dataset.speed);
                if (speedSlider) speedSlider.value = morphDuration;
                if (speedValue) speedValue.textContent = (morphDuration / 1000).toFixed(1) + 's';
                speedPresets.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        const intensitySlider = document.getElementById('intensitySlider');
        const intensityValue = document.getElementById('intensityValue');
        if (intensitySlider) {
            intensitySlider.addEventListener('input', () => {
                intensityMultiplier = parseInt(intensitySlider.value) / 100;
                if (intensityValue) intensityValue.textContent = intensitySlider.value + '%';
                applyIntensityAll();
            });
        }

        const radiusSlider = document.getElementById('radiusSlider');
        const radiusValue = document.getElementById('radiusValue');
        if (radiusSlider) {
            radiusSlider.addEventListener('input', () => {
                radiusMultiplier = parseInt(radiusSlider.value) / 100;
                if (radiusValue) radiusValue.textContent = radiusSlider.value + '%';
                applyRadiusAll();
            });
        }

        const resetBtn = document.getElementById('resetSettings');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                morphDuration = 1000;
                intensityMultiplier = 1;
                radiusMultiplier = 1;
                if (speedSlider) speedSlider.value = 1000;
                if (speedValue) speedValue.textContent = '1.0s';
                if (intensitySlider) intensitySlider.value = 100;
                if (intensityValue) intensityValue.textContent = '100%';
                if (radiusSlider) radiusSlider.value = 100;
                if (radiusValue) radiusValue.textContent = '100%';
                speedPresets.forEach(btn => btn.classList.toggle('active', parseInt(btn.dataset.speed) === 1000));
                applyIntensityAll();
                applyRadiusAll();
            });
        }
    }

    // ============================================================
    // PRESETS
    // ============================================================
    const NORTH_PACIFIC_OCEANS = ['North Pacific Ocean', 'Bering Sea', 'Gulf of Alaska', 'Sea of Okhotsk', 'Sea of Japan', 'Philippine Sea', 'East China Sea', 'Golfo de California', 'Monterey Bay', 'Prince William Sound', 'Cook Inlet', 'Bristol Bay', 'Salish Sea', 'Hecate Strait', 'Queen Charlotte Strait', 'Queen Charlotte Sound'];
    const NORTH_ATLANTIC_OCEANS = ['North Atlantic Ocean', 'Gulf of Maine', 'Gulf of Saint Lawrence', 'Bay of Fundy', 'Labrador Sea', 'Davis Strait', 'Baffin Bay', 'Caribbean Sea', 'Gulf of Mexico', 'Norwegian Sea', 'North Sea'];
    const NORTH_ARCTIC_OCEANS = ['Arctic Ocean', 'Chukchi Sea', 'Bering Sea', 'Beaufort Sea', 'Baffin Bay', 'Davis Strait', 'Greenland Sea', 'Norwegian Sea', 'Barents Sea', 'Labrador Sea'];
    const SOUTHERN_OCEANS = ['Southern Ocean', 'South Atlantic Ocean', 'South Pacific Ocean', 'Drake Passage', 'Scotia Sea', 'Weddell Sea', 'Ross Sea', 'Tasman Sea', 'Great Australian Bight', 'Indian Ocean'];

    const presets = {
        north_pacific: { species: ['Blue', 'Humpback', 'Gray'], filterLayers: { 'humpback': NORTH_PACIFIC_OCEANS }, center: [-123, 38], zoom: 6 },
        north_atlantic: { species: ['Humpback', 'Fin', 'Minke', 'Sei', 'North Atlantic Right', 'Right'], filterLayers: { 'humpback': NORTH_ATLANTIC_OCEANS }, center: [-45, 42], zoom: 2 },
        arctic: { species: ['Beluga', 'Orca'], filterLayers: { 'orca': NORTH_ARCTIC_OCEANS }, center: [-80, 70], zoom: 2 },
        southern_ocean: { species: ['Blue', 'Fin', 'Humpback', 'Southern Right', 'Orca', 'Sei'], filterLayers: { 'humpback': SOUTHERN_OCEANS, 'orca': SOUTHERN_OCEANS }, center: [0, -55], zoom: 2 }
    };

    window.getActivePresetFilters = () => activePreset ? activePreset.filterLayers : null;

    function setupPresets() {
        document.querySelectorAll('.preset-card').forEach(card => {
            card.addEventListener('click', () => {
                applyPreset(card.dataset.preset);
                document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
            });
        });

        document.querySelectorAll('.preset-utility-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.preset === 'clear') clearAllSpecies();
                else if (btn.dataset.preset === 'all') showAllSpecies();
                document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('active'));
            });
        });
    }

    function applyPreset(presetName) {
        const preset = presets[presetName];
        if (!preset) return;

        stopAnimation();
        activePreset = preset;
        clearOceanFilters();

        document.querySelectorAll('#speciesList input[type="checkbox"]').forEach(cb => {
            const config = SPECIES_CONFIG.find(s => s.id === cb.dataset.species);
            if (!config) return;
            const shouldShow = preset.species.some(s => config.name.toLowerCase().includes(s.toLowerCase()));
            cb.checked = shouldShow;
            toggleSpeciesVisibility(cb.dataset.species, shouldShow);
            syncMobileCheckbox(cb.dataset.species, shouldShow);
        });

        setTimeout(() => {
            applyOceanFilters(preset.filterLayers);
            setWeightAll(phase);
        }, 300);

        map.flyTo({ center: preset.center, zoom: preset.zoom, duration: 1500 });
        updateAllSpeciesToggle();
    }

    function applyOceanFilters(filterLayers) {
        if (!filterLayers) return;
        SPECIES_CONFIG.forEach(species => {
            if (!map.getLayer(species.id)) return;
            let oceanList = null;
            for (const [key, oceans] of Object.entries(filterLayers)) {
                if (species.id.toLowerCase().includes(key.toLowerCase())) {
                    oceanList = oceans;
                    break;
                }
            }
            if (oceanList) {
                map.setPaintProperty(species.id, 'heatmap-weight', ['case', ['in', ['get', 'ocean'], ['literal', oceanList]], 1, 0]);
            }
        });
    }

    function clearOceanFilters() {
        activePreset = null;
        SPECIES_CONFIG.forEach(species => {
            if (map.getLayer(species.id)) map.setPaintProperty(species.id, 'heatmap-weight', 1);
        });
    }

    function showAllSpecies() {
        activePreset = null;
        clearOceanFilters();
        document.querySelectorAll('#speciesList input[type="checkbox"]').forEach(cb => {
            cb.checked = true;
            toggleSpeciesVisibility(cb.dataset.species, true);
            syncMobileCheckbox(cb.dataset.species, true);
        });
        document.getElementById('allSpeciesToggle').checked = true;
        allSpeciesOn = true;
        setWeightAll(phase);
        map.flyTo({ center: [0, 20], zoom: 1.5, duration: 1500 });
    }

    function clearAllSpecies() {
        activePreset = null;
        clearOceanFilters();
        document.querySelectorAll('#speciesList input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
            toggleSpeciesVisibility(cb.dataset.species, false);
            syncMobileCheckbox(cb.dataset.species, false);
        });
        document.getElementById('allSpeciesToggle').checked = false;
        allSpeciesOn = false;
    }

    // ============================================================
    // MOBILE FLOATING BUTTONS
    // ============================================================
    function setupMobileControls() {
        const mobileInfoBtn = document.getElementById('mobileInfoBtn');
        const mobileInfoPanel = document.getElementById('mobileInfoPanel');
        const mobileAnimBtn = document.getElementById('mobileAnimBtn');
        const mobileAnimPanel = document.getElementById('mobileAnimPanel');

        // Toggle info panel
        if (mobileInfoBtn && mobileInfoPanel) {
            mobileInfoBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileAnimPanel?.classList.remove('open');
                mobileAnimBtn?.classList.remove('active');
                mobileInfoPanel.classList.toggle('open');
                mobileInfoBtn.classList.toggle('active', mobileInfoPanel.classList.contains('open'));
            });
        }

        // Toggle animation panel
        if (mobileAnimBtn && mobileAnimPanel) {
            mobileAnimBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileInfoPanel?.classList.remove('open');
                mobileInfoBtn?.classList.remove('active');
                mobileAnimPanel.classList.toggle('open');
                mobileAnimBtn.classList.toggle('active', mobileAnimPanel.classList.contains('open'));
            });
        }

        // Close panels when clicking outside
        document.addEventListener('click', (e) => {
            if (!mobileInfoBtn?.contains(e.target) && !mobileInfoPanel?.contains(e.target)) {
                mobileInfoPanel?.classList.remove('open');
                mobileInfoBtn?.classList.remove('active');
            }
            if (!mobileAnimBtn?.contains(e.target) && !mobileAnimPanel?.contains(e.target)) {
                mobileAnimPanel?.classList.remove('open');
                mobileAnimBtn?.classList.remove('active');
            }
        });

        // Mobile animation speed buttons
        const mobileAnimSpeedBtns = document.querySelectorAll('.mobile-anim-speed-btn');
        mobileAnimSpeedBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const speed = parseInt(btn.dataset.speed);
                morphDuration = speed;

                // Update mobile buttons
                mobileAnimSpeedBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Sync with desktop
                const desktopSlider = document.getElementById('speedSlider');
                const desktopValue = document.getElementById('speedValue');
                if (desktopSlider) desktopSlider.value = speed;
                if (desktopValue) desktopValue.textContent = (speed / 1000).toFixed(1) + 's';
                document.querySelectorAll('.speed-preset-btn').forEach(b => {
                    b.classList.toggle('active', parseInt(b.dataset.speed) === speed);
                });
            });
        });

        // Mobile animation intensity slider
        const mobileAnimIntensitySlider = document.getElementById('mobileAnimIntensitySlider');
        const mobileAnimIntensityVal = document.getElementById('mobileAnimIntensityVal');

        if (mobileAnimIntensitySlider) {
            mobileAnimIntensitySlider.addEventListener('input', () => {
                intensityMultiplier = parseInt(mobileAnimIntensitySlider.value) / 100;
                if (mobileAnimIntensityVal) mobileAnimIntensityVal.textContent = mobileAnimIntensitySlider.value + '%';
                applyIntensityAll();

                // Sync with desktop
                const desktopSlider = document.getElementById('intensitySlider');
                const desktopValue = document.getElementById('intensityValue');
                if (desktopSlider) desktopSlider.value = mobileAnimIntensitySlider.value;
                if (desktopValue) desktopValue.textContent = mobileAnimIntensitySlider.value + '%';
            });
        }

        // Mobile animation radius slider
        const mobileAnimRadiusSlider = document.getElementById('mobileAnimRadiusSlider');
        const mobileAnimRadiusVal = document.getElementById('mobileAnimRadiusVal');

        if (mobileAnimRadiusSlider) {
            mobileAnimRadiusSlider.addEventListener('input', () => {
                radiusMultiplier = parseInt(mobileAnimRadiusSlider.value) / 100;
                if (mobileAnimRadiusVal) mobileAnimRadiusVal.textContent = mobileAnimRadiusSlider.value + '%';
                applyRadiusAll();

                // Sync with desktop
                const desktopSlider = document.getElementById('radiusSlider');
                const desktopValue = document.getElementById('radiusValue');
                if (desktopSlider) desktopSlider.value = mobileAnimRadiusSlider.value;
                if (desktopValue) desktopValue.textContent = mobileAnimRadiusSlider.value + '%';
            });
        }
    }

    // ============================================================
    // INITIALIZATION
    // ============================================================
    setupNavToggle();
    map.on('load', () => {
        addSpeciesLayers();
        generateSpeciesCards();

        if (typeof CircularControls !== 'undefined') {
            circularControls = new CircularControls({
                container: '#controls',
                onMonthChange: (month) => setMonth(month),
                onPlayToggle: () => isPlaying ? stopAnimation() : startAnimation(),
                getIsPlaying: () => isPlaying,
                getCurrentMonth: () => monthA
            });
        }

        setupTabs();
        setupAllSpeciesToggle();
        setupProjectionToggle();
        setupBasemapToggle();
        setupFullscreen();
        setupAnimationSettings();
        setupPresets();
        setupMobileControls();

        // Map Tips
        const mapTipsBtn = document.getElementById('mapTipsBtn');
        const mapTipsTooltip = document.getElementById('mapTipsTooltip');
        if (mapTipsBtn && mapTipsTooltip) {
            mapTipsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                mapTipsTooltip.classList.toggle('show');
            });
            document.addEventListener('click', (e) => {
                if (!mapTipsBtn.contains(e.target) && !mapTipsTooltip.contains(e.target)) {
                    mapTipsTooltip.classList.remove('show');
                }
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                mapTipsTooltip?.classList.remove('show');
                // Close mobile floating panels
                document.querySelectorAll('.mobile-floating-panel').forEach(p => p.classList.remove('open'));
                document.querySelectorAll('.mobile-floating-btn').forEach(b => b.classList.remove('active'));
            }
        });

        // Resize map after layout
        setTimeout(() => map.resize(), 100);
    });

    // ============================================================
    // LOADING ANIMATION & WELCOME MODAL HANDLER
    // ============================================================
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingVideo = document.getElementById('loadingVideo');
    const welcomeModal = document.getElementById('welcomeModal');
    const welcomeBtn = document.getElementById('welcomeBtn');
    const welcomeLoading = document.getElementById('welcomeLoading');

    let mapIsReady = false;
    let videoEnded = false;

    function updateWelcomeButton() {
        if (welcomeBtn && welcomeLoading) {
            if (mapIsReady) {
                welcomeBtn.disabled = false;
                welcomeBtn.textContent = 'Explore the Map';
                welcomeLoading.classList.add('ready');
                welcomeLoading.querySelector('span').textContent = 'Map ready!';
            } else {
                welcomeBtn.disabled = true;
                welcomeBtn.textContent = 'Loading map...';
                welcomeLoading.classList.remove('ready');
                welcomeLoading.querySelector('span').textContent = 'Preparing map data...';
            }
        }
    }

    function dismissWelcome() {
        if (welcomeModal) {
            welcomeModal.classList.add('hidden');
        }
    }

    // Mark map as ready when fully loaded and rendered
    // 'idle' fires when all tiles in viewport are loaded and rendered
    map.on('idle', function onFirstIdle() {
        mapIsReady = true;
        updateWelcomeButton();
        map.off('idle', onFirstIdle); // Only trigger once
    });

    if (loadingVideo && loadingOverlay) {
        // Hide loading overlay when video ends (welcome modal takes over)
        loadingVideo.addEventListener('ended', () => {
            videoEnded = true;
            loadingOverlay.classList.add('hidden');
            updateWelcomeButton();
        });

        // Fallback: hide after video duration + buffer
        loadingVideo.addEventListener('loadedmetadata', () => {
            const duration = loadingVideo.duration * 1000 + 500;
            setTimeout(() => {
                if (!videoEnded) {
                    videoEnded = true;
                    loadingOverlay.classList.add('hidden');
                    updateWelcomeButton();
                }
            }, duration);
        });

        // If video fails to load, hide overlay after 3 seconds
        loadingVideo.addEventListener('error', () => {
            setTimeout(() => {
                videoEnded = true;
                loadingOverlay.classList.add('hidden');
                updateWelcomeButton();
            }, 3000);
        });

        // Skip animation on click/tap
        loadingOverlay.addEventListener('click', () => {
            videoEnded = true;
            loadingOverlay.classList.add('hidden');
            updateWelcomeButton();
        });
    }

    // Welcome modal button
    if (welcomeBtn) {
        welcomeBtn.addEventListener('click', () => {
            if (mapIsReady) {
                dismissWelcome();
            }
        });
    }

    // Allow clicking outside content to dismiss (if map is ready)
    if (welcomeModal) {
        welcomeModal.addEventListener('click', (e) => {
            if (e.target === welcomeModal && mapIsReady) {
                dismissWelcome();
            }
        });
    }

    // Escape key to dismiss welcome modal
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mapIsReady && welcomeModal && !welcomeModal.classList.contains('hidden')) {
            dismissWelcome();
        }
    });
    </script>
</body>
</html>
