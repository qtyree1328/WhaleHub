<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Whale Migration Density Map - Whale Watchers Atlas</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="description" content="Explore whale migration patterns, species diversity, and discover the best whale watching locations worldwide.">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --nav-height: 72px;
            --sidebar-width: 380px;
        }

        /* ============================================================
           CSS RESET & BASE
           ============================================================ */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #0a1628;
        }

        #navbar {
            z-index: 1000;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: var(--nav-height);
            display: flex;
            align-items: center;
        }

        #navbar .nav-container {
            padding: 8px 14px;
            gap: 12px;
            flex-wrap: nowrap;
            height: 100%;
            width: 100%;
            max-width: none;
            margin: 0;
        }

        #navbar .nav-brand {
            padding: 8px 0;
            gap: 8px;
            font-size: 18px;
            margin-right: auto;
        }

        #navbar .nav-links {
            gap: 6px;
            flex-wrap: nowrap;
        }

        #navbar .nav-link {
            padding: 8px 12px;
            font-size: 13px;
            white-space: nowrap;
        }

        /* Hamburger toggle */
        #navbar .nav-toggle {
            display: none;
            width: 38px;
            height: 38px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.1);
            color: #fff;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-direction: column;
            cursor: pointer;
        }

        #navbar .nav-toggle span {
            display: block;
            width: 18px;
            height: 2px;
            background: currentColor;
            border-radius: 4px;
        }

        /* ============================================================
           LAYOUT: Fixed sidebar + map area
           ============================================================ */
        .sidebar {
            position: fixed;
            top: var(--nav-height);
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--nav-height));
            background: rgba(10, 22, 40, 0.98);
            backdrop-filter: blur(10px);
            z-index: 50;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .map-wrapper {
            position: fixed;
            top: var(--nav-height);
            left: var(--sidebar-width);
            right: 0;
            bottom: 0;
            height: calc(100vh - var(--nav-height));
            min-height: calc(100vh - var(--nav-height));
            background: #0a1628;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100% !important;
            height: 100% !important;
            background: #0a1628;
            max-width: none !important;
            margin: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        /* Force Mapbox canvas to fill container */
        #map.mapboxgl-map {
            width: 100% !important;
            height: 100% !important;
        }

        .mapboxgl-canvas-container,
        .mapboxgl-canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* ============================================================
           SIDEBAR HEADER
           ============================================================ */
        .sidebar-header {
            padding: 32px 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 12px;
        }

        .sidebar-title {
            font-family: 'Oswald', sans-serif;
            font-size: 22px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .sidebar-stats {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 12px;
            margin-bottom: 12px;
        }

        .sidebar-stat {
            text-align: center;
        }

        .sidebar-stat-value {
            font-family: 'Oswald', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: #1a6db0;
            line-height: 1;
        }

        .sidebar-stat-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-top: 4px;
        }

        .sidebar-description {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.6;
        }

        /* ============================================================
           SIDEBAR SECTIONS
           ============================================================ */
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #4ecdc4;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title svg {
            width: 16px;
            height: 16px;
        }

        .section-content {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
        }

        .section-content p {
            margin-bottom: 10px;
        }

        .section-content p:last-child {
            margin-bottom: 0;
        }

        /* ============================================================
           ANIMATION CONTROLS IN SIDEBAR
           ============================================================ */
        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .control-label span {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .control-value {
            font-size: 11px;
            font-weight: 600;
            color: #4ecdc4;
            background: rgba(78, 205, 196, 0.15);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .control-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #4ecdc4 0%, rgba(255, 255, 255, 0.2) 0%);
            outline: none;
            cursor: pointer;
        }

        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #4ecdc4;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .control-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #4ecdc4;
            cursor: pointer;
        }

        .control-description {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 6px;
        }

        .speed-presets {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .preset-btn {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: transparent;
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preset-btn:hover {
            border-color: #4ecdc4;
            color: #4ecdc4;
        }

        .preset-btn.active {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.15);
            color: #4ecdc4;
        }

        /* ============================================================
           PROJECTION TOGGLE - Centered at top of map (matches species.html)
           ============================================================ */
        .projection-toggle {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            background: rgba(10, 35, 66, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            overflow: hidden;
            z-index: 40;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .projection-btn {
            padding: 10px 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .projection-btn:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .projection-btn.active {
            background: #1a6db0;
            color: #fff;
        }

        /* ============================================================
           MAP CONTROLS PANEL - TOP RIGHT (Basemap only)
           ============================================================ */
        .map-controls-panel {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 10;
        }

        .map-control-group {
            background: rgba(10, 35, 66, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 8px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .map-control-label {
            font-size: 9px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            text-align: center;
        }

        /* Basemap toggle */
        .basemap-toggle {
            display: flex;
            gap: 4px;
        }

        .basemap-btn {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(26, 109, 176, 0.25);
            font-size: 9px;
            font-weight: 600;
            color: #d9ecff;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .basemap-btn:hover {
            border-color: #4ecdc4;
            background: rgba(26, 109, 176, 0.55);
            color: #ffffff;
        }

        .basemap-btn.active {
            border-color: #4ecdc4;
            background: #1a6db0;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .basemap-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Color scheme grid */
        .colormap-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .colormap-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 6px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .colormap-btn:hover {
            border-color: #4ecdc4;
        }

        .colormap-btn.active {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.15);
        }

        .colormap-preview {
            width: 100%;
            height: 12px;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .colormap-btn span {
            font-size: 9px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
        }

        .colormap-btn.active span {
            color: #4ecdc4;
        }

        .reset-btn {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: transparent;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 16px;
        }

        .reset-btn:hover {
            border-color: #e74c3c;
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        /* ============================================================
           LEGEND - TOP LEFT OF MAP
           ============================================================ */
        #legend {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 10;
            background: rgba(10, 35, 66, 0.92);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 380px;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        /* Density Toggle in Legend - inline with title */
        .density-toggle {
            display: none;
        }

        .density-toggle-label {
            display: none;
        }

        .density-switch {
            position: relative;
            width: 40px;
            height: 22px;
        }

        .density-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .density-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 22px;
        }

        .density-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .density-switch input:checked + .density-slider {
            background-color: #2c7ab8;
        }

        .density-switch input:checked + .density-slider:before {
            transform: translateX(18px);
        }

        .legend-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .legend-title-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-title .density-switch {
            position: relative;
            width: 36px;
            height: 20px;
            flex-shrink: 0;
        }

        .legend-title .density-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .legend-title .density-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 20px;
        }

        .legend-title .density-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .legend-title .density-switch input:checked + .density-slider {
            background-color: #2c7ab8;
        }

        .legend-title .density-switch input:checked + .density-slider:before {
            transform: translateX(16px);
        }

        .legend-gradient .gradient-bar {
            height: 12px;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .legend-gradient .gradient-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .legend-note {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }

        .legend-description {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }

        .legend-close {
            display: none;
        }

        /* ============================================================
           MONTH SLIDER - BOTTOM RIGHT OF MAP
           ============================================================ */
        #controls {
            position: absolute !important;
            bottom: 24px !important;
            right: 24px !important;
            left: auto !important;
            top: auto !important;
            z-index: 10 !important;
            background: rgba(10, 35, 66, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35) !important;
            backdrop-filter: blur(10px) !important;
            border-radius: 16px !important;
            padding: 12px !important;
            width: fit-content !important;
        }

        .control-header {
            font-size: 11px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            text-align: center;
        }

        .circular-selector {
            position: relative;
            width: 140px !important;
            height: 140px !important;
            margin: 0 auto;
        }

        .month-wheel {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .month-marker {
            position: absolute;
            width: 28px !important;
            height: 28px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
            user-select: none;
            z-index: 2;
        }

        .month-marker:hover {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
            transform: scale(1.1);
        }

        .month-marker.active {
            background: #4ecdc4;
            color: #0a2342;
            box-shadow: 0 2px 8px rgba(78, 205, 196, 0.4);
            transform: scale(1.15);
        }

        .center-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px !important;
            height: 70px !important;
            border-radius: 50%;
            background: rgba(10, 35, 66, 0.95);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3;
        }

        .center-month {
            font-size: 12px;
            font-weight: 700;
            color: #4ecdc4;
            margin-bottom: 2px;
        }

        .center-hint {
            font-size: 8px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rotation-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50%;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #4ecdc4 60%, #4ecdc4 100%);
            transform-origin: left center;
            z-index: 1;
            pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .rotation-indicator::after {
            content: '';
            position: absolute;
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #4ecdc4;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(78, 205, 196, 0.5);
        }

        .drag-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            cursor: grab;
            z-index: 4;
        }

        .drag-ring:active {
            cursor: grabbing;
        }

        .drag-ring::before {
            content: '';
            position: absolute;
            inset: 6px;
            border-radius: 50%;
            border: 2px dashed rgba(78, 205, 196, 0.2);
            pointer-events: none;
        }

        .play-controls {
            display: flex;
            justify-content: center;
            margin-top: 14px;
            gap: 6px;
        }

        .control-button {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #4ecdc4;
            color: #0a2342;
        }

        .control-button:hover {
            background: #3dbdb5;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
        }

        .control-button.playing {
            background: #e74c3c;
        }

        .control-button.playing:hover {
            background: #c0392b;
        }

        .nav-arrows {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 10px;
        }

        .nav-arrow {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: rgba(255, 255, 255, 0.6);
        }

        .nav-arrow:hover {
            background: #4ecdc4;
            color: #0a2342;
        }

        .nav-arrow svg {
            width: 16px;
            height: 16px;
        }

        #monthSlider, .month-display {
            display: none;
        }

        #monthBottom {
            display: none;
        }

        /* ============================================================
           LOCATION INFO PANEL
           ============================================================ */
        .info-panel {
            position: fixed !important;
            top: 120px !important;
            right: 16px !important;
            bottom: 60px !important;
            height: auto !important;
            width: 400px;
            max-width: 90vw;
            background: #ffffff;
            box-shadow: -4px 0 18px rgba(0,0,0,0.18);
            display: flex;
            flex-direction: column;
            transform: translateX(calc(100% + 20px));
            transition: transform 0.3s ease, visibility 0.3s ease;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            z-index: 50000 !important;
            visibility: hidden;
            border-radius: 12px;
            overflow: hidden;
        }

        .info-panel.open {
            transform: translateX(0);
            visibility: visible;
        }

        .info-panel-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 10px 16px 10px 50px;
            border-bottom: 1px solid #eee;
            min-height: 50px;
        }

        .info-panel-title-group h3 {
            margin: 0;
            font-size: 18px;
        }

        .info-panel-title-group p {
            margin: 2px 0 0 0;
            font-size: 12px;
            color: #666;
        }

        .info-panel-close-fold {
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #f0f0f0 50%, transparent 50%);
            border: none;
            cursor: pointer;
            z-index: 50010;
            transition: all 0.2s ease;
        }

        .info-panel-close-fold::before {
            content: 'Ã—';
            position: absolute;
            top: 6px;
            left: 8px;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            line-height: 1;
        }

        .info-panel-close-fold:hover {
            background: linear-gradient(135deg, #e0e0e0 50%, transparent 50%);
        }

        .info-panel-close-fold:hover::before {
            color: #333;
        }

        .info-panel-body {
            flex: 1;
            overflow-y: auto;
        }

        .location-panel-header-media {
            position: relative;
            width: 100%;
            height: 180px;
        }

        .location-panel-header-media img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: opacity 0.3s ease;
        }

        .panel-image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 8px;
            pointer-events: none;
            z-index: 5;
        }

        .panel-image-nav.hidden { display: none; }

        .panel-nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            transition: all 0.2s ease;
        }

        .panel-nav-btn:hover { background: rgba(0,0,0,0.7); }
        .panel-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .panel-image-counter {
            position: absolute;
            bottom: 50px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            z-index: 5;
        }

        .panel-image-counter.hidden { display: none; }

        .location-name-overlay-panel {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 24px 18px 10px;
            background: linear-gradient(transparent, rgba(0,0,0,0.85));
            color: #fff;
        }

        .location-name-overlay-panel .location-name {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .location-name-overlay-panel .location-region {
            font-size: 13px;
            margin: 4px 0 0 0;
            opacity: 0.95;
        }

        .location-panel-content {
            padding: 18px;
        }

        .score-container {
            display: flex;
            gap: 10px;
            margin-bottom: 18px;
            justify-content: center;
        }

        .score-circle {
            text-align: center;
            position: relative;
            cursor: help;
        }

        .score-circle:hover .score-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .score-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: normal;
            max-width: 200px;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            margin-top: 8px;
            z-index: 10;
            pointer-events: none;
        }

        .score-tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.9);
        }

        .circle-svg { width: 50px; height: 50px; }
        .circle-bg { fill: none; stroke: #f0f0f0; stroke-width: 5; }
        .circle-progress {
            fill: none;
            stroke-width: 5;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.6s ease;
            transform-origin: center;
            transform: rotate(-90deg);
        }
        .score-value { font-size: 14px; font-weight: 700; fill: #333; }
        .score-label { font-size: 10px; color: #666; margin-top: 4px; font-weight: 600; }

        .species-list {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 14px;
        }

        .species-title {
            font-size: 11px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 7px;
        }

        .species-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .species-tag {
            background: white;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            color: #2c7ab8;
            border: 1px solid #e0e0e0;
            font-weight: 500;
        }

        .info-section {
            margin-bottom: 14px;
        }

        .info-label {
            font-size: 10px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-text {
            font-size: 13px;
            color: #333;
            line-height: 1.5;
        }

        .best-months {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
        }

        .month-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 7px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .accessibility-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .excellent { background: #d4edda; color: #155724; }
        .good { background: #d1ecf1; color: #0c5460; }
        .moderate { background: #fff3cd; color: #856404; }

        /* Monthly density chart */
        .monthly-density-chart {
            background: #f8f9fa;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 14px;
        }

        .chart-title {
            font-size: 11px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .month-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 80px;
            gap: 2px;
            padding: 0 4px;
        }

        .month-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            position: relative;
        }

        .bar-wrapper {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .stacked-bar {
            width: 100%;
            display: flex;
            flex-direction: column-reverse;
            border-radius: 2px 2px 0 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .species-segment { width: 100%; }

        .bar-count {
            font-size: 9px;
            color: #444;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .bar-label {
            font-size: 8px;
            color: #666;
            font-weight: 600;
            line-height: 1;
            margin-top: 3px;
            flex-shrink: 0;
        }

        .month-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: #fff;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 11px;
            min-width: 120px;
            max-width: 180px;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.15s ease;
            z-index: 20;
        }

        .month-bar:hover .month-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .tooltip-species {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 10px;
            margin-bottom: 2px;
        }

        .tooltip-color {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .species-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 10px;
            color: #555;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 4px;
            border: 1px solid rgba(0,0,0,0.15);
        }

        /* Tourism stats */
        .tourism-stats {
            background: #f0f7ff;
            padding: 12px;
            border-radius: 8px;
            margin-top: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-item { display: flex; flex-direction: column; }

        .stat-label {
            font-size: 9px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 13px;
            color: #1976d2;
            font-weight: 600;
        }

        .info-panel-body::-webkit-scrollbar { width: 6px; }
        .info-panel-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .info-panel-body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        .info-panel-body::-webkit-scrollbar-thumb:hover { background: #aaa; }

        /* ============================================================
           MOBILE UI ELEMENTS (hidden by default)
           ============================================================ */

        /* Mobile Description Button - Top Left */
        .mobile-desc-btn {
            display: none;
            position: absolute;
            top: 12px;
            left: 12px;
            width: 40px;
            height: 40px;
            background: rgba(10, 35, 66, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            z-index: 100;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .mobile-desc-btn:hover {
            background: rgba(20, 50, 90, 0.95);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .mobile-desc-btn.active {
            background: #4ecdc4;
            border-color: #4ecdc4;
            color: #0a2342;
        }

        .mobile-desc-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Mobile Description Panel */
        .mobile-desc-panel {
            display: none;
            position: absolute;
            top: 60px;
            left: 12px;
            width: calc(100% - 24px);
            max-width: 320px;
            max-height: 50vh;
            background: rgba(10, 35, 66, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 16px;
            z-index: 90;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .mobile-desc-panel.open {
            display: block;
        }

        .mobile-desc-title {
            font-family: 'Oswald', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-desc-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .mobile-desc-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-desc-section-title {
            font-size: 11px;
            font-weight: 600;
            color: #4ecdc4;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        /* Mobile Basemap Box - Top Right (smaller, compact) */
        .mobile-basemap-container {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 100;
            background: rgba(10, 35, 66, 0.92);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 6px 8px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
            overflow: visible;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .mobile-basemap-label {
            font-size: 8px;
            font-weight: 700;
            color: #d9ecff;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 4px;
            text-align: center;
        }

        .mobile-basemap-select {
            width: 100%;
            padding: 4px 20px 4px 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 24 24' fill='none' stroke='%23d9ecff' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 6px center;
            font-size: 10px;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            min-width: 70px;
        }

        .mobile-basemap-select:hover {
            border-color: #4ecdc4;
        }

        .mobile-basemap-select:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.25);
        }

        /* Hide old dropdown styles */
        .mobile-basemap-btn-main,
        .mobile-basemap-dropdown {
            display: none !important;
        }

        /* Mobile Bottom Panel - Fixed at bottom */
        .mobile-bottom-panel {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 35, 66, 0.98);
            backdrop-filter: blur(10px);
            z-index: 500;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Mobile Legend - Full width at top of bottom panel */
        .mobile-legend {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .mobile-legend-title {
            font-size: 10px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .mobile-legend-gradient {
            flex: 1;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right,
                rgba(0,0,80,0.4),
                rgba(0,100,255,0.6),
                rgba(0,200,255,0.7),
                rgba(100,255,200,0.8),
                rgba(255,220,0,0.9),
                rgba(255,100,0,0.95),
                rgba(255,0,150,1));
        }

        .mobile-legend-label {
            font-size: 9px;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .mobile-density-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mobile-density-toggle label {
            position: relative;
            width: 32px;
            height: 18px;
        }

        .mobile-density-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .mobile-density-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            transition: 0.3s;
            border-radius: 18px;
        }

        .mobile-density-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .mobile-density-toggle input:checked + .mobile-density-slider {
            background-color: #2c7ab8;
        }

        .mobile-density-toggle input:checked + .mobile-density-slider:before {
            transform: translateX(14px);
        }

        /* Mobile Bottom Content - Controls + Slider */
        .mobile-bottom-content {
            display: flex;
            height: 180px;
            padding: 12px;
            gap: 12px;
        }

        /* Left side - Animation Controls */
        .mobile-controls-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .mobile-control-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 6px 8px;
        }

        .mobile-control-label {
            font-size: 8px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .mobile-speed-btns {
            display: flex;
            gap: 3px;
        }

        .mobile-speed-btn {
            flex: 1;
            padding: 4px 5px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mobile-speed-btn.active {
            background: #4ecdc4;
            border-color: #4ecdc4;
            color: #0a2342;
        }

        .mobile-colormap-btns {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
        }

        .mobile-colormap-btn {
            padding: 3px 6px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 7px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mobile-colormap-btn.active {
            background: #1a6db0;
            border-color: #1a6db0;
            color: #fff;
        }

        .mobile-anim-row {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .mobile-anim-label {
            font-size: 8px;
            color: rgba(255, 255, 255, 0.5);
            min-width: 45px;
        }

        .mobile-anim-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
        }

        .mobile-anim-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            background: #4ecdc4;
            border-radius: 50%;
            cursor: pointer;
        }

        .mobile-anim-value {
            font-size: 8px;
            color: #4ecdc4;
            min-width: 28px;
            text-align: right;
        }

        /* Right side - Month Slider (35% width) */
        .mobile-slider-right {
            width: 35%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding-left: 12px;
        }

        /* ============================================================
           MOBILE RESPONSIVE
           ============================================================ */
        @media (max-width: 900px) {
            #navbar .nav-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            #navbar .nav-links {
                display: none;
                position: absolute;
                top: var(--nav-height);
                left: 0;
                right: 0;
                padding: 12px 16px;
                background: rgba(10, 35, 66, 0.96);
                flex-direction: column;
                gap: 8px;
                box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
            }

            #navbar.nav-open .nav-links {
                display: flex;
            }

            #navbar .nav-toggle {
                display: inline-flex;
            }

            #navbar .nav-links .nav-link {
                width: 100%;
                text-align: left;
            }

            .sidebar {
                display: none;
            }

            :root {
                --sidebar-width: 0px;
                --mobile-panel-height: 230px;
            }

            .map-wrapper {
                left: 0 !important;
                right: 0 !important;
                top: var(--nav-height) !important;
                bottom: var(--mobile-panel-height) !important;
                height: auto !important;
                min-height: auto !important;
            }

            #map {
                left: 0 !important;
                right: 0 !important;
                top: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Show mobile UI elements */
            .mobile-desc-btn {
                display: flex;
            }

            .mobile-bottom-panel {
                display: block;
                height: var(--mobile-panel-height);
            }

            .mobile-basemap-container {
                display: block;
            }

            /* Hide desktop controls and legend */
            .map-controls-panel {
                display: none;
            }

            #legend {
                display: none;
            }

            /* Month slider in bottom panel - reset positioning */
            #controls {
                position: static !important;
                transform: none !important;
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
            }

            .mobile-bottom-panel #controls {
                width: 100% !important;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            /* Bottom panel layout - 60/40 split with larger dial */
            .mobile-bottom-content {
                display: flex;
                height: 190px;
                padding: 14px;
                gap: 14px;
            }

            .mobile-controls-left {
                width: 60%;
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                gap: 8px;
                overflow-y: auto;
                padding-right: 10px;
            }

            .mobile-slider-right {
                width: 40%;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                border-left: 1px solid rgba(255, 255, 255, 0.1);
                padding-left: 14px;
            }

            /* Circular selector styling for mobile */
            .circular-selector {
                width: 170px !important;
                height: 170px !important;
                position: relative !important;
                margin: 0 auto !important;
            }

            .month-wheel {
                display: block !important;
                background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%) !important;
            }

            .month-marker {
                display: flex !important;
                width: 28px !important;
                height: 28px !important;
                font-size: 8px !important;
                color: rgba(255, 255, 255, 0.7) !important;
                background: transparent !important;
            }

            .month-marker:hover {
                background: rgba(78, 205, 196, 0.2) !important;
                color: #4ecdc4 !important;
            }

            .month-marker.active {
                background: #4ecdc4 !important;
                color: #0a2342 !important;
            }

            .drag-handle {
                display: block !important;
                background: #4ecdc4 !important;
            }

            .nav-ring {
                display: flex !important;
            }

            .nav-ring-half {
                color: rgba(255, 255, 255, 0.6) !important;
            }

            .nav-ring-half:hover {
                color: #4ecdc4 !important;
            }

            .center-display {
                width: 60px !important;
                height: 60px !important;
                background: rgba(10, 35, 66, 0.95) !important;
                border: 2px solid rgba(78, 205, 196, 0.3) !important;
            }

            .center-month {
                font-size: 11px !important;
                font-weight: 700 !important;
                color: #4ecdc4 !important;
            }

            .center-play-icon {
                font-size: 10px !important;
                color: rgba(255, 255, 255, 0.8) !important;
            }

            .rotation-indicator {
                display: block !important;
                background: linear-gradient(90deg, transparent 0%, #4ecdc4 60%, #4ecdc4 100%) !important;
            }

            .rotation-indicator::after {
                background: #4ecdc4 !important;
            }

            /* Hide extra controls */
            .nav-arrows { display: none !important; }
            .play-controls { display: none !important; }
            .control-header { display: none !important; }

            /* Projection toggle */
            .projection-toggle {
                left: 50%;
                top: 12px;
            }

            .projection-btn {
                padding: 8px 12px;
                font-size: 10px;
            }

            /* Mobile info panel - shorter height, above everything */
            .info-panel {
                top: calc(var(--nav-height) + 20px);
                right: 8px;
                bottom: 220px;
                border-radius: 12px;
            }

            .info-panel-header {
                padding: 8px 12px 8px 40px !important;
                min-height: 40px !important;
            }

            .info-panel-close-fold {
                width: 32px !important;
                height: 32px !important;
            }

            .info-panel-close-fold::before {
                top: 4px !important;
                left: 6px !important;
                font-size: 14px !important;
            }

            .location-panel-header-media {
                height: 120px !important;
            }
        }

        @media (max-width: 480px) {
            :root {
                --mobile-panel-height: 220px;
            }

            .mobile-bottom-content {
                height: 180px;
                padding: 12px;
                gap: 12px;
            }

            .mobile-slider-right {
                width: 150px;
            }

            .circular-selector {
                width: 140px !important;
                height: 140px !important;
            }

            .month-marker {
                width: 24px !important;
                height: 24px !important;
                font-size: 7px !important;
            }

            .center-display {
                width: 50px !important;
                height: 50px !important;
            }

            .center-month { font-size: 10px !important; }
            .center-play-icon { font-size: 9px !important; }

            .mobile-desc-btn {
                width: 36px;
                height: 36px;
            }

            .mobile-desc-btn svg {
                width: 18px;
                height: 18px;
            }

            .projection-btn {
                padding: 6px 10px;
                font-size: 9px;
            }
        }

        /* ============================================================
           LOADING ANIMATION OVERLAY
           ============================================================ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            z-index: 900;
            background: #0e2c4b;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-overlay video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transform: scale(1.1);
        }

        /* Desktop: smaller centered video */
        @media (min-width: 768px) {
            .loading-overlay video {
                max-width: 50%;
                max-height: 60%;
            }
        }

        @media (min-width: 1200px) {
            .loading-overlay video {
                max-width: 40%;
                max-height: 50%;
            }
        }

        /* ============================================================
           WELCOME MODAL - Map Usage Instructions
           ============================================================ */
        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            z-index: 800;
            background: rgba(10, 22, 40, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }

        .welcome-modal.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .welcome-content {
            background: linear-gradient(135deg, #0f2d4a 0%, #1a4a6e 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 24px;
            max-width: 420px;
            width: 90%;
            max-height: 78vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .welcome-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .welcome-header h2 {
            color: #fff;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .welcome-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .welcome-tips {
            margin-bottom: 24px;
        }

        .welcome-tip {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .welcome-tip:last-child {
            border-bottom: none;
        }

        .tip-icon {
            width: 36px;
            height: 36px;
            background: rgba(78, 205, 196, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
        }

        .tip-text {
            flex: 1;
        }

        .tip-text h4 {
            color: #4ecdc4;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tip-text p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            line-height: 1.4;
        }

        .welcome-footer {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .welcome-btn {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a8a0 100%);
            color: #0a1628;
            border: none;
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .welcome-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(78, 205, 196, 0.3);
        }

        .welcome-btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .welcome-loading {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .welcome-loading.ready {
            color: #4ecdc4;
        }

        .loading-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: #4ecdc4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .welcome-loading.ready .loading-spinner {
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .welcome-modal {
                align-items: flex-start;
                padding-top: 15vh;
            }

            .welcome-content {
                padding: 16px;
                margin: 12px;
                max-width: 320px;
                max-height: 60vh;
            }

            .welcome-header h2 {
                font-size: 18px;
            }

            .welcome-header p {
                font-size: 12px;
            }

            .tip-icon {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .tip-text h4 {
                font-size: 12px;
            }

            .tip-text p {
                font-size: 11px;
            }

            .welcome-btn {
                padding: 12px 24px;
                font-size: 13px;
            }

            .welcome-tip {
                padding: 8px 0;
                gap: 10px;
            }
        }
    </style>
</head>
<body class="page-enter">
    <!-- Loading Animation Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <video id="loadingVideo" autoplay muted playsinline>
            <source src="models/animation_video.webm" type="video/webm">
        </video>
    </div>

    <!-- Welcome Modal - Map Usage Instructions -->
    <div class="welcome-modal" id="welcomeModal">
        <div class="welcome-content">
            <div class="welcome-header">
                <h2>Whale Density Map</h2>
                <p>Explore global whale population density patterns</p>
            </div>
            <div class="welcome-tips">
                <div class="welcome-tip">
                    <div class="tip-icon">ðŸ—ºï¸</div>
                    <div class="tip-text">
                        <h4>Density Visualization</h4>
                        <p>Colors indicate whale population density - brighter areas show higher concentrations.</p>
                    </div>
                </div>
                <div class="welcome-tip">
                    <div class="tip-icon">ðŸ“…</div>
                    <div class="tip-text">
                        <h4>Monthly Animation</h4>
                        <p>Use the circular dial to view different months or press play to animate through the year.</p>
                    </div>
                </div>
                <div class="welcome-tip">
                    <div class="tip-icon">ðŸŒ</div>
                    <div class="tip-text">
                        <h4>Navigate the Globe</h4>
                        <p>Click and drag to rotate. Scroll or pinch to zoom. Double-click to zoom in on an area.</p>
                    </div>
                </div>
                <div class="welcome-tip">
                    <div class="tip-icon">âš™ï¸</div>
                    <div class="tip-text">
                        <h4>Customize View</h4>
                        <p>Adjust intensity, radius, and switch between globe and flat map projections.</p>
                    </div>
                </div>
            </div>
            <div class="welcome-footer">
                <button class="welcome-btn" id="welcomeBtn" disabled>Loading map...</button>
                <div class="welcome-loading" id="welcomeLoading">
                    <div class="loading-spinner"></div>
                    <span>Preparing map data...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav id="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <span class="whale-icon">
                    <img src="favicon.ico" alt="Whale Icon" class="whale-icon-img">
                </span>
                <span class="brand-text">Whale Watchers Atlas</span>
            </a>
            <button class="nav-toggle" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-links">
                <a href="density-map.html" class="nav-link active">Density Map</a>
                <a href="species.html" class="nav-link">Species Map</a>
                <a href="whale-species-gallery.html" class="nav-link">Whale Species</a>
                <a href="whale-locations-gallery.html" class="nav-link">Locations</a>
                <a href="about.html" class="nav-link">About</a>
            </div>
        </div>
    </nav>

    <!-- Fixed Sidebar Panel -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1 class="sidebar-title">Whale Migration Density</h1>
            <div class="sidebar-stats">
                <div class="sidebar-stat">
                    <div class="sidebar-stat-value">11</div>
                    <div class="sidebar-stat-label">Species</div>
                </div>
                <div class="sidebar-stat">
                    <div class="sidebar-stat-value">20</div>
                    <div class="sidebar-stat-label">Years of Data</div>
                </div>
            </div>
            <p class="sidebar-description">This animated heatmap demonstrates global whale species density patterns across all seasons. Brighter areas indicate more species overlap in one location at a given time. Values are aggregated by spatial hexagons and monthly bins to show where species overlap through the year. Use the circular month selector to watch migration patterns shift throughout the year.</p>
        </div>

        <!-- How to Read Section -->
        <div class="sidebar-section">
            <div class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4M12 8h.01"/>
                </svg>
                How to Read This Map
            </div>
            <div class="section-content">
                <p>Click the black pins to view popular whale watching locations worldwide.</p>
                <p>Drag the circular dial (bottom-right) to scrub months or press play to animate.</p>
                <p>Brighter hexes indicate higher combined density across all tracked species.</p>
            </div>
        </div>

        <!-- Animation Controls Section -->
        <div class="sidebar-section">
            <div class="section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
                </svg>
                Animation Settings
            </div>
            <div class="section-content">
                <!-- Transition Speed -->
                <div class="control-group">
                    <div class="control-label">
                        <span>Transition Speed</span>
                        <span class="control-value" id="speedValue">1.0s</span>
                    </div>
                    <input type="range" class="control-slider" id="speedSlider" min="200" max="3000" value="1000" step="100">
                    <div class="control-description">Time to transition between months</div>
                </div>

                <!-- Color Scheme -->
                <div class="control-group">
                    <div class="control-label">
                        <span>Color Scheme</span>
                    </div>
                    <div class="colormap-grid" id="colormapGrid">
                        <button class="colormap-btn active" data-colormap="default" title="Spectrum">
                            <div class="colormap-preview" style="background: linear-gradient(to right, rgba(0,0,80,1), rgba(0,100,255,1), rgba(0,200,255,1), rgba(100,255,200,1), rgba(255,220,0,1), rgba(255,100,0,1), rgba(255,0,150,1));"></div>
                            <span>Spectrum</span>
                        </button>
                        <button class="colormap-btn" data-colormap="ocean" title="Ocean">
                            <div class="colormap-preview" style="background: linear-gradient(to right, #0a1628, #0d3b66, #1a759f, #34a0a4, #76c893, #b5e48c);"></div>
                            <span>Ocean</span>
                        </button>
                        <button class="colormap-btn" data-colormap="thermal" title="Thermal">
                            <div class="colormap-preview" style="background: linear-gradient(to right, #000033, #1a0066, #4d0099, #9900cc, #ff3366, #ffcc00);"></div>
                            <span>Thermal</span>
                        </button>
                        <button class="colormap-btn" data-colormap="viridis" title="Viridis">
                            <div class="colormap-preview" style="background: linear-gradient(to right, #440154, #3b528b, #21918c, #5ec962, #fde725);"></div>
                            <span>Viridis</span>
                        </button>
                        <button class="colormap-btn" data-colormap="magma" title="Magma">
                            <div class="colormap-preview" style="background: linear-gradient(to right, #000004, #3b0f70, #8c2981, #de4968, #fea16e, #fcfdbf);"></div>
                            <span>Magma</span>
                        </button>
                        <button class="colormap-btn" data-colormap="cool" title="Plasma">
                            <div class="colormap-preview" style="background: linear-gradient(to right, #0d0887, #5302a3, #8b0aa5, #b83289, #db5c68, #f48849, #febd2a);"></div>
                            <span>Plasma</span>
                        </button>
                    </div>
                </div>

                <!-- Heatmap Intensity -->
                <div class="control-group">
                    <div class="control-label">
                        <span>Heatmap Intensity</span>
                        <span class="control-value" id="intensityValue">100%</span>
                    </div>
                    <input type="range" class="control-slider" id="intensitySlider" min="20" max="200" value="100" step="10">
                    <div class="control-description">Brightness of species density overlay</div>
                </div>

                <!-- Heatmap Radius -->
                <div class="control-group">
                    <div class="control-label">
                        <span>Heatmap Radius</span>
                        <span class="control-value" id="radiusValue">100%</span>
                    </div>
                    <input type="range" class="control-slider" id="radiusSlider" min="50" max="200" value="100" step="10">
                    <div class="control-description">Spread of each data point</div>
                </div>

                <button class="reset-btn" id="resetSettings">Reset to Defaults</button>
            </div>
        </div>
    </aside>

    <!-- Map Container -->
    <div class="map-wrapper">
        <div id="map">
            <!-- Circular Month Controls - Bottom Right -->
            <div id="controls">
                <!-- Content generated by CircularControls component -->
            </div>

            <!-- Hidden Month Display -->
            <div id="monthBottom">January</div>

            <!-- Legend - Top Left -->
            <div id="legend">
                <div class="legend-title">
                    <span class="legend-title-text">
                        Species Diversity
                        <label class="density-switch">
                            <input type="checkbox" id="densityToggle" checked>
                            <span class="density-slider"></span>
                        </label>
                    </span>
                    <button class="legend-close" id="legendClose">&times;</button>
                </div>
                <div class="legend-gradient">
                    <div class="gradient-bar" style="background: linear-gradient(to right,
                        rgba(0,0,80,0.4),
                        rgba(0,100,255,0.6),
                        rgba(0,200,255,0.7),
                        rgba(100,255,200,0.8),
                        rgba(255,220,0,0.9),
                        rgba(255,100,0,0.95),
                        rgba(255,0,150,1));"></div>
                    <div class="gradient-labels">
                        <span>Lower</span>
                        <span>Higher</span>
                    </div>
                </div>
                <div class="legend-note">
                    <span style="color: #000000;">â—</span> Click pins for whale watching locations
                </div>
                <div class="legend-description">
                </div>
            </div>

            <!-- Projection Toggle - Centered at top (like species.html) -->
            <div class="projection-toggle">
                <button class="projection-btn active" data-projection="globe">Globe</button>
                <button class="projection-btn" data-projection="mercator">Flat</button>
            </div>

            <!-- Map Controls Panel - Top Right (Basemap only) -->
            <div class="map-controls-panel">
                <div class="map-control-group">
                    <div class="map-control-label">Basemap</div>
                    <div class="basemap-toggle">
                        <button class="basemap-btn" data-basemap="satellite" title="Satellite">
                            <svg viewBox="0 0 24 24" fill="#333" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                            </svg>
                            Satellite
                        </button>
                        <button class="basemap-btn" data-basemap="bathymetry" title="Bathymetry">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M2 12c2-3 4-4 6-4s4 2 6 2 4-2 6-2 4 1 4 4"/>
                                <path d="M2 16c2-2 4-3 6-3s4 1.5 6 1.5 4-1.5 6-1.5 4 1 4 3"/>
                                <path d="M2 8c2-2 4-3 6-3s4 1 6 1 4-1 6-1"/>
                            </svg>
                            Ocean
                        </button>
                        <button class="basemap-btn active" data-basemap="custom" title="Custom Style">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                <path d="M2 17l10 5 10-5"/>
                                <path d="M2 12l10 5 10-5"/>
                            </svg>
                            Terrain
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mobile Description Button - Top Left -->
            <button class="mobile-desc-btn" id="mobileDescBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4M12 8h.01"/>
                </svg>
            </button>

            <!-- Mobile Description Panel -->
            <div class="mobile-desc-panel" id="mobileDescPanel">
                <div class="mobile-desc-title">Whale Migration Density</div>
                <p class="mobile-desc-text">This interactive density map visualizes global whale migration patterns using data from over 11 species across 20+ years of observations.</p>
                <div class="mobile-desc-section">
                    <div class="mobile-desc-section-title">How to Read This Map</div>
                    <p class="mobile-desc-text" style="margin-bottom: 0;">The heatmap shows whale concentration - warmer colors indicate higher density of sightings. Use the month slider to see how patterns change throughout the year.</p>
                </div>
                <div class="mobile-desc-section">
                    <div class="mobile-desc-section-title">Data Info</div>
                    <p class="mobile-desc-text" style="margin-bottom: 0;">Hexagonal bins aggregate monthly sightings. Higher resolution appears as you zoom in. Tap location pins for whale watching site details.</p>
                </div>
            </div>

            <!-- Mobile Basemap Box - Top Right (matches desktop style) -->
            <div class="mobile-basemap-container" id="mobileBasemapContainer">
                <div class="mobile-basemap-label">Basemap</div>
                <select class="mobile-basemap-select" id="mobileBasemapSelect">
                    <option value="satellite">Satellite</option>
                    <option value="bathymetry">Ocean</option>
                    <option value="custom" selected>Terrain</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Side Info Panel (overlay) - Outside map-wrapper for proper z-index -->
    <div id="infoPanel" class="info-panel">
        <button id="infoPanelClose" class="info-panel-close-fold" aria-label="Close"></button>
        <div class="info-panel-header">
            <div class="info-panel-title-group">
                <h3 id="infoPanelTitle">Location</h3>
                <p id="infoPanelSubtitle"></p>
            </div>
        </div>
        <div id="infoPanelBody" class="info-panel-body">
            <!-- filled dynamically -->
        </div>
    </div>

    <!-- Mobile Bottom Panel -->
    <div class="mobile-bottom-panel" id="mobileBottomPanel">
        <!-- Legend - Full width at top -->
        <div class="mobile-legend">
            <span class="mobile-legend-title">Species Diversity</span>
            <span class="mobile-legend-label">Low</span>
            <div class="mobile-legend-gradient"></div>
            <span class="mobile-legend-label">High</span>
            <div class="mobile-density-toggle">
                <label>
                    <input type="checkbox" id="mobileDensityToggle" checked>
                    <span class="mobile-density-slider"></span>
                </label>
            </div>
        </div>

        <!-- Controls + Slider -->
        <div class="mobile-bottom-content">
            <!-- Left: Animation Controls -->
            <div class="mobile-controls-left">
                <div class="mobile-control-section">
                    <div class="mobile-control-label">Speed</div>
                    <div class="mobile-anim-row">
                        <span class="mobile-anim-label">Transition</span>
                        <input type="range" class="mobile-anim-slider" id="mobileSpeedSlider" min="200" max="3000" value="1000" step="100">
                        <span class="mobile-anim-value" id="mobileSpeedVal">1.0s</span>
                    </div>
                </div>
                <div class="mobile-control-section">
                    <div class="mobile-control-label">Color Scheme</div>
                    <div class="mobile-colormap-btns">
                        <button class="mobile-colormap-btn active" data-colormap="default">Spectrum</button>
                        <button class="mobile-colormap-btn" data-colormap="viridis">Viridis</button>
                        <button class="mobile-colormap-btn" data-colormap="thermal">Thermal</button>
                        <button class="mobile-colormap-btn" data-colormap="magma">Magma</button>
                    </div>
                </div>
                <div class="mobile-control-section">
                    <div class="mobile-control-label">Heatmap</div>
                    <div class="mobile-anim-row">
                        <span class="mobile-anim-label">Intensity</span>
                        <input type="range" class="mobile-anim-slider" id="mobileIntensitySlider" min="20" max="200" value="100">
                        <span class="mobile-anim-value" id="mobileIntensityVal">100%</span>
                    </div>
                    <div class="mobile-anim-row" style="margin-top: 4px;">
                        <span class="mobile-anim-label">Radius</span>
                        <input type="range" class="mobile-anim-slider" id="mobileRadiusSlider" min="50" max="200" value="100">
                        <span class="mobile-anim-value" id="mobileRadiusVal">100%</span>
                    </div>
                </div>
            </div>
            <!-- Right: Month Slider -->
            <div class="mobile-slider-right" id="mobileSliderContainer">
                <!-- Circular controls will be moved here on mobile -->
            </div>
        </div>
    </div>

    <script src="circular-controls.js"></script>
    <script src="whale-locations.js"></script>
    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        const MAPBOX_TOKEN = 'pk.eyJ1IjoicXR5cmVlIiwiYSI6ImNtaHl5eHNmeDBoY3oybXEwNTIxNGgxYmsifQ.VqoAKKHQxQX-lNNPwVKHmw';
        const TILESET_URL = 'mapbox://qtyree.wd11_12bin_p_hex2_40';
        const SOURCE_LAYER = 'WD11_12bin_p_hex2_40';

        // ============================================================
        // CONSTANTS
        // ============================================================
        const TOTAL_BINS = 12;
        const BINS_PER_MONTH = 1;

        const MONTH_NAMES = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];

        const MONTH_ABBREV = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        const SPECIES_COLORS = {
            "Blue Whale": "#2980b9",
            "Sperm Whale": "#c0392b",
            "Humpback Whale": "#3498db",
            "Grey Whale": "#7f8c8d",
            "Fin Whale": "#8e44ad",
            "Minke Whale": "#27ae60",
            "Beluga Whale": "#ecf0f1",
            "Southern Right Whale": "#d35400",
            "North Atlantic Right Whale": "#e67e22",
            "Humpback whale": "#3498db",
            "Blue whale": "#2980b9",
            "Gray whale": "#7f8c8d",
            "Grey whale": "#7f8c8d",
            "Orca": "#2c3e50",
            "Fin whale": "#8e44ad",
            "Sperm whale": "#c0392b",
            "Minke whale": "#27ae60",
            "Southern right whale": "#d35400",
            "North Atlantic right whale": "#e67e22",
            "Right whale": "#d35400",
            "Beluga whale": "#ecf0f1",
            "Sei whale": "#9b59b6",
            "Bryde's whale": "#1abc9c",
            "Pilot whale": "#34495e",
            "Beaked whale": "#f39c12",
            "default": "#95a5a6"
        };

        function getSpeciesColor(name) {
            if (!name) return SPECIES_COLORS.default;
            return SPECIES_COLORS[name] || SPECIES_COLORS.default;
        }

        // ============================================================
        // HELPER FUNCTIONS
        // ============================================================
        function binToMonth(bin) {
            return Math.floor((bin - 1) / BINS_PER_MONTH) + 1;
        }

        // ============================================================
        // ANIMATION STATE
        // ============================================================
        let binA = 1;
        let binB = 2;
        let phase = 0;
        let startTime = null;
        let animFrame = null;
        let isPlaying = false;
        let morphDuration = 1000;

        mapboxgl.accessToken = MAPBOX_TOKEN;

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/qtyree/cmkq3f00c003001qs2qib3wlr',
            projection: 'globe',
            center: [-110, 35],
            zoom: 2
        });

        const infoPanel = document.getElementById('infoPanel');
        const infoPanelTitle = document.getElementById('infoPanelTitle');
        const infoPanelSubtitle = document.getElementById('infoPanelSubtitle');
        const infoPanelBody = document.getElementById('infoPanelBody');
        const infoPanelClose = document.getElementById('infoPanelClose');

        // ============================================================
        // CIRCULAR CONTROLS COMPONENT
        // ============================================================
        let circularControls = null;

        function initCircularControls() {
            if (typeof CircularControls === 'undefined') {
                console.warn('CircularControls not loaded');
                return;
            }

            circularControls = new CircularControls({
                container: '#controls',
                onMonthChange: (month) => {
                    setMonthFromControls(month);
                },
                onPlayToggle: () => {
                    isPlaying ? stopAnimation() : startAnimation();
                },
                getIsPlaying: () => isPlaying,
                getCurrentMonth: () => binA
            });
        }

        function setMonthFromControls(month) {
            stopAnimation();
            binA = month;
            binB = (binA % TOTAL_BINS) + 1;
            document.getElementById('monthBottom').textContent = MONTH_NAMES[month - 1];
            snapToCurrentMonth();
        }

        // ============================================================
        // ANIMATION FUNCTIONS
        // ============================================================
        function updateLabels() {
            const month = binToMonth(binA);
            const label = MONTH_NAMES[month - 1];
            document.getElementById('monthBottom').textContent = label;

            if (circularControls) {
                circularControls.externalSetMonth(month);
            }
        }

        function setFilterAll() {
            if (map.getLayer('density-heatmap')) {
                map.setFilter('density-heatmap', [
                    'in', ['get', 'bin'], ['literal', [binA, binB]]
                ]);
            }
        }

        function setWeightAll(phaseVal) {
            if (map.getLayer('density-heatmap')) {
                const densityWeight = [
                    'interpolate',
                    ['exponential', 1.5],
                    ['get', 'density'],
                    1, 0.3,
                    2, 0.45,
                    3, 0.55,
                    4, 0.65,
                    5, 0.75,
                    6, 0.85,
                    7, 0.92,
                    8, 1.0
                ];

                const weightExpr = [
                    '*',
                    densityWeight,
                    [
                        'case',
                        ['==', ['get', 'bin'], binA], 1 - phaseVal,
                        ['==', ['get', 'bin'], binB], phaseVal,
                        0
                    ]
                ];
                map.setPaintProperty('density-heatmap', 'heatmap-weight', weightExpr);
            }
        }

        function snapToCurrentMonth() {
            if (map.getLayer('density-heatmap')) {
                map.setFilter('density-heatmap', [
                    '==', ['get', 'bin'], binA
                ]);

                const densityWeight = [
                    'interpolate',
                    ['exponential', 1.5],
                    ['get', 'density'],
                    1, 0.3,
                    2, 0.45,
                    3, 0.55,
                    4, 0.65,
                    5, 0.75,
                    6, 0.85,
                    7, 0.92,
                    8, 1.0
                ];
                map.setPaintProperty('density-heatmap', 'heatmap-weight', densityWeight);
            }
        }

        function stepAnimation(timestamp) {
            if (!isPlaying) return;

            if (startTime === null) startTime = timestamp;
            const elapsed = timestamp - startTime;
            phase = Math.min(elapsed / morphDuration, 1);

            setWeightAll(phase);

            if (phase < 1) {
                if (isPlaying) {
                    animFrame = requestAnimationFrame(stepAnimation);
                }
            } else {
                binA = binB;
                binB = (binB % TOTAL_BINS) + 1;
                setFilterAll();
                updateLabels();
                startTime = null;
                phase = 0;

                if (isPlaying) {
                    animFrame = requestAnimationFrame(stepAnimation);
                }
            }
        }

        function startAnimation() {
            if (isPlaying) return;
            isPlaying = true;
            if (circularControls) {
                circularControls.setPlaying(true);
            } else {
                const playPauseBtn = document.getElementById('playPause');
                if (playPauseBtn) {
                    playPauseBtn.textContent = 'â¸ Pause';
                    playPauseBtn.classList.add('playing');
                }
            }
            binB = (binA % TOTAL_BINS) + 1;
            setFilterAll();
            startTime = null;
            phase = 0;
            animFrame = requestAnimationFrame(stepAnimation);
        }

        function stopAnimation() {
            isPlaying = false;

            if (animFrame) {
                cancelAnimationFrame(animFrame);
                animFrame = null;
            }

            startTime = null;
            phase = 0;
            snapToCurrentMonth();

            if (circularControls) {
                circularControls.setPlaying(false);
            } else {
                const playPauseBtn = document.getElementById('playPause');
                if (playPauseBtn) {
                    playPauseBtn.textContent = 'â–¶ Play';
                    playPauseBtn.classList.remove('playing');
                }
            }
        }

        // ============================================================
        // PANEL FUNCTIONS
        // ============================================================
        function createCircularProgress(value, color) {
            const radius = 21;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (value / 100) * circumference;

            return `
                <svg class="circle-svg" viewBox="0 0 50 50">
                    <circle class="circle-bg" cx="25" cy="25" r="${radius}"></circle>
                    <circle class="circle-progress" cx="25" cy="25" r="${radius}"
                        stroke="${color}"
                        stroke-dasharray="${circumference}"
                        stroke-dashoffset="${offset}">
                    </circle>
                    <text x="25" y="28.5" text-anchor="middle" class="score-value" fill="${color}">
                        ${value}
                    </text>
                </svg>
            `;
        }

        function createMonthlyDensityChart(location) {
            const speciesMonthly = location.speciesMonthly;
            if (!speciesMonthly || typeof speciesMonthly !== "object") return "";

            const orderedSpecies = Object.keys(speciesMonthly);
            const numMonths = 12;
            const MAX_SPECIES_LEVELS = 5;
            const monthlyCounts = new Array(numMonths).fill(0);

            orderedSpecies.forEach(sp => {
                const arr = speciesMonthly[sp] || [];
                for (let m = 0; m < numMonths; m++) {
                    if (arr[m] > 0) monthlyCounts[m] += 1;
                }
            });

            const anyCount = monthlyCounts.some(c => c > 0);
            if (!anyCount) return "";

            const bars = monthlyCounts.map((count, monthIndex) => {
                if (!count) {
                    return `
                        <div class="month-bar">
                            <div class="bar-wrapper">
                                <div class="stacked-bar" style="height:0%;"></div>
                            </div>
                            <div class="bar-label">${MONTH_ABBREV[monthIndex]}</div>
                        </div>
                    `;
                }

                const presentSpecies = orderedSpecies.filter(sp => {
                    const arr = speciesMonthly[sp];
                    return Array.isArray(arr) && arr[monthIndex] > 0;
                });

                const clampedCount = Math.min(count, MAX_SPECIES_LEVELS);
                const barHeightPercent = (clampedCount / MAX_SPECIES_LEVELS) * 100;

                const segments = presentSpecies.map(sp => {
                    const color = getSpeciesColor(sp);
                    return `
                        <div class="species-segment"
                            style="background:${color}; height:${100 / presentSpecies.length}%"
                            title="${sp}">
                        </div>
                    `;
                }).join("");

                const tooltipSpecies = presentSpecies.map(sp => {
                    const color = getSpeciesColor(sp);
                    return `
                        <div class="tooltip-species">
                            <span class="tooltip-color" style="background:${color};"></span>${sp}
                        </div>
                    `;
                }).join("");

                return `
                    <div class="month-bar">
                        <div class="month-tooltip">
                            <div class="tooltip-title">${MONTH_NAMES[monthIndex]}</div>
                            <div style="font-size:11px;margin-bottom:4px;">${count} species</div>
                            ${tooltipSpecies}
                        </div>
                        <div class="bar-count">${count}</div>
                        <div class="bar-wrapper">
                            <div class="stacked-bar"
                                style="height:${barHeightPercent}%; min-height:4px;">
                                ${segments}
                            </div>
                        </div>
                        <div class="bar-label">${MONTH_ABBREV[monthIndex]}</div>
                    </div>
                `;
            }).join("");

            const legendItems = orderedSpecies.map(sp => {
                const color = getSpeciesColor(sp);
                return `
                    <div class="legend-item">
                        <span class="legend-color" style="background:${color};"></span>
                        ${sp.replace(" whale", "")}
                    </div>
                `;
            }).join("");

            return `
                <div class="monthly-density-chart">
                    <div class="chart-title">Species Stacked by Month</div>
                    <div class="month-bars">${bars}</div>
                    <div class="species-legend">${legendItems}</div>
                </div>
            `;
        }

        function formatNumber(num) {
            if (!num) return 'N/A';
            return num.toLocaleString();
        }

        function createLocationPanelHTML(location) {
            const accessibilityClass = location.accessibility.toLowerCase();
            const bestMonthsHTML = location.bestMonths.map(m =>
                `<span class="month-badge">${MONTH_NAMES[m-1].substring(0,3)}</span>`
            ).join('');

            const monthlyChartHTML = createMonthlyDensityChart(location);

            const images = location.imageUrls && Array.isArray(location.imageUrls) && location.imageUrls.length > 0
                ? location.imageUrls
                : [location.imageUrl || 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=600&h=400&fit=crop'];

            const hasMultipleImages = images.length > 1;
            const imageUrl = images[0];

            return `
                <div class="location-panel-header-media" data-images='${JSON.stringify(images)}' data-current-index="0">
                    <img src="${imageUrl}" alt="${location.name}" referrerpolicy="no-referrer" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=600&h=400&fit=crop';">
                    <div class="panel-image-nav ${hasMultipleImages ? '' : 'hidden'}">
                        <button class="panel-nav-btn panel-prev-btn" disabled onclick="panelPrevImage(event)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                        </button>
                        <button class="panel-nav-btn panel-next-btn" onclick="panelNextImage(event)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                        </button>
                    </div>
                    <div class="panel-image-counter ${hasMultipleImages ? '' : 'hidden'}">1 / ${images.length}</div>
                    <div class="location-name-overlay-panel">
                        <h3 class="location-name">${location.name}</h3>
                        <p class="location-region">${location.location}</p>
                    </div>
                </div>
                <div class="location-panel-content">
                    <div class="score-container">
                        <div class="score-circle">
                            <div class="score-tooltip">Quality of whale behaviors and interactions</div>
                            ${createCircularProgress(location.entertainment, '#FF6B6B')}
                            <div class="score-label">Experience</div>
                        </div>
                        <div class="score-circle">
                            <div class="score-tooltip">Likelihood of seeing whales clearly</div>
                            ${createCircularProgress(location.visibility, '#4CAF50')}
                            <div class="score-label">Sighting Rate</div>
                        </div>
                    </div>

                    <div class="info-section">
                        <div class="info-label">What Makes It Special</div>
                        <div class="info-text">${location.specialNotes}</div>
                    </div>

                    ${monthlyChartHTML}

                    <div class="species-list">
                        <div class="species-title">Species Present</div>
                        <div class="species-tags">
                            ${location.species.map(s => `<span class="species-tag">${s}</span>`).join('')}
                        </div>
                    </div>

                    <div class="info-section">
                        <div class="info-label">Best Months</div>
                        <div class="best-months">${bestMonthsHTML}</div>
                    </div>

                    <div class="info-section">
                        <div class="info-label">Accessibility</div>
                        <span class="accessibility-badge ${accessibilityClass}">${location.accessibility}</span>
                    </div>

                    <div class="tourism-stats">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-label">Industry Size</div>
                                <div class="stat-value">${location.industrySize || 'N/A'}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Annual Visitors</div>
                                <div class="stat-value">${formatNumber(location.annualVisitors)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function panelPrevImage(event) {
            event.stopPropagation();
            const mediaContainer = document.querySelector('.location-panel-header-media');
            if (!mediaContainer) return;

            const images = JSON.parse(mediaContainer.dataset.images);
            let currentIndex = parseInt(mediaContainer.dataset.currentIndex);

            if (currentIndex > 0) {
                currentIndex--;
                mediaContainer.dataset.currentIndex = currentIndex;
                updatePanelImage(mediaContainer, images, currentIndex);
            }
        }

        function panelNextImage(event) {
            event.stopPropagation();
            const mediaContainer = document.querySelector('.location-panel-header-media');
            if (!mediaContainer) return;

            const images = JSON.parse(mediaContainer.dataset.images);
            let currentIndex = parseInt(mediaContainer.dataset.currentIndex);

            if (currentIndex < images.length - 1) {
                currentIndex++;
                mediaContainer.dataset.currentIndex = currentIndex;
                updatePanelImage(mediaContainer, images, currentIndex);
            }
        }

        function updatePanelImage(container, images, index) {
            const img = container.querySelector('img');
            const counter = container.querySelector('.panel-image-counter');
            const prevBtn = container.querySelector('.panel-prev-btn');
            const nextBtn = container.querySelector('.panel-next-btn');

            img.style.opacity = '0';
            setTimeout(() => {
                img.src = images[index];
                img.style.opacity = '1';
            }, 150);

            counter.textContent = `${index + 1} / ${images.length}`;
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === images.length - 1;
        }

        function openInfoPanel(location) {
            infoPanelTitle.textContent = location.name;
            infoPanelSubtitle.textContent = location.location;
            infoPanelBody.innerHTML = createLocationPanelHTML(location);
            infoPanel.classList.add('open');
        }

        function closeInfoPanel() {
            infoPanel.classList.remove('open');
        }

        infoPanelClose.addEventListener('click', closeInfoPanel);

        // ============================================================
        // MAP LOAD
        // ============================================================
        map.on('load', () => {
            initCircularControls();
            map.addSource('density-points', {
                type: 'vector',
                url: TILESET_URL
            });

            map.addLayer({
                'id': 'density-heatmap',
                'type': 'heatmap',
                'source': 'density-points',
                'source-layer': SOURCE_LAYER,
                'maxzoom': 9,
                'paint': {
                    'heatmap-weight': [
                        'interpolate',
                        ['exponential', 1.5],
                        ['get', 'density'],
                        1, 0.3,
                        2, 0.45,
                        3, 0.55,
                        4, 0.65,
                        5, 0.75,
                        6, 0.85,
                        7, 0.92,
                        8, 1.0
                    ],
                    'heatmap-intensity': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        0, 1.0,
                        5, 1.5,
                        8, 2.0
                    ],
                    'heatmap-color': [
                        'interpolate',
                        ['linear'],
                        ['heatmap-density'],
                        0.0, 'rgba(0,0,0,0)',
                        0.1, 'rgba(0,0,80,0.3)',
                        0.25, 'rgba(0,100,255,0.5)',
                        0.4, 'rgba(0,200,255,0.65)',
                        0.55, 'rgba(100,255,200,0.75)',
                        0.7, 'rgba(255,220,0,0.85)',
                        0.85, 'rgba(255,100,0,0.95)',
                        1.0, 'rgba(255,0,150,1)'
                    ],
                    'heatmap-radius': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        0, 3,
                        4, 15,
                        8, 30
                    ],
                    'heatmap-opacity': 0.85,
                    'heatmap-opacity-transition': { duration: 0, delay: 0 },
                    'heatmap-radius-transition': { duration: 0, delay: 0 },
                    'heatmap-weight-transition': { duration: 0, delay: 0 }
                },
                'filter': ['in', ['get', 'bin'], ['literal', [binA, binB]]]
            });

            const whaleGeoJSON = {
                type: 'FeatureCollection',
                features: WHALE_WATCHING_LOCATIONS.map((loc, idx) => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: loc.coordinates
                    },
                    properties: {
                        index: idx
                    }
                }))
            };

            map.addSource('whale-locations', {
                type: 'geojson',
                data: whaleGeoJSON
            });

            map.addLayer({
                id: 'whale-locations-halo',
                type: 'circle',
                source: 'whale-locations',
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        0, 6,
                        4, 8,
                        8, 10
                    ],
                    'circle-color': 'rgba(0,0,0,0.3)',
                    'circle-stroke-width': 0
                }
            });

            map.addLayer({
                id: 'whale-locations-layer',
                type: 'circle',
                source: 'whale-locations',
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        0, 4,
                        4, 5,
                        8, 7
                    ],
                    'circle-color': '#000000',
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 1.5
                }
            });

            map.on('mouseenter', 'whale-locations-layer', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'whale-locations-layer', () => {
                map.getCanvas().style.cursor = '';
            });

            map.on('click', 'whale-locations-layer', (e) => {
                if (!e.features || !e.features.length) return;
                const feature = e.features[0];
                const idx = parseInt(feature.properties.index, 10);
                const location = WHALE_WATCHING_LOCATIONS[idx];
                openInfoPanel(location);
            });

            setFilterAll();
            setWeightAll(0);
            updateLabels();
            updateSliderFill(speedSlider);
            updateSliderFill(intensitySlider);
            updateSliderFill(radiusSlider);
        });

        // ============================================================
        // ANIMATION SETTINGS (SIDEBAR)
        // ============================================================
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const intensitySlider = document.getElementById('intensitySlider');
        const intensityValue = document.getElementById('intensityValue');
        const radiusSlider = document.getElementById('radiusSlider');
        const radiusValue = document.getElementById('radiusValue');
        const resetSettings = document.getElementById('resetSettings');
        const colormapBtns = document.querySelectorAll('.colormap-btn');
        const mobileSpeedSlider = document.getElementById('mobileSpeedSlider');
        const mobileSpeedVal = document.getElementById('mobileSpeedVal');

        // Colormap definitions
        const COLORMAPS = {
            default: [
                [0.0, 'rgba(0,0,0,0)'],
                [0.1, 'rgba(0,0,80,0.3)'],
                [0.25, 'rgba(0,100,255,0.5)'],
                [0.4, 'rgba(0,200,255,0.65)'],
                [0.55, 'rgba(100,255,200,0.75)'],
                [0.7, 'rgba(255,220,0,0.85)'],
                [0.85, 'rgba(255,100,0,0.95)'],
                [1.0, 'rgba(255,0,150,1)']
            ],
            ocean: [
                [0.0, 'rgba(0,0,0,0)'],
                [0.1, 'rgba(10,22,40,0.4)'],
                [0.25, 'rgba(13,59,102,0.55)'],
                [0.4, 'rgba(26,117,159,0.65)'],
                [0.55, 'rgba(52,160,164,0.75)'],
                [0.7, 'rgba(118,200,147,0.85)'],
                [0.85, 'rgba(181,228,140,0.92)'],
                [1.0, 'rgba(217,249,187,1)']
            ],
            thermal: [
                [0.0, 'rgba(0,0,0,0)'],
                [0.1, 'rgba(0,0,51,0.4)'],
                [0.25, 'rgba(26,0,102,0.55)'],
                [0.4, 'rgba(77,0,153,0.65)'],
                [0.55, 'rgba(153,0,204,0.75)'],
                [0.7, 'rgba(255,51,102,0.85)'],
                [0.85, 'rgba(255,153,51,0.92)'],
                [1.0, 'rgba(255,204,0,1)']
            ],
            viridis: [
                [0.0, 'rgba(0,0,0,0)'],
                [0.1, 'rgba(68,1,84,0.4)'],
                [0.25, 'rgba(59,82,139,0.55)'],
                [0.4, 'rgba(33,145,140,0.65)'],
                [0.55, 'rgba(94,201,98,0.75)'],
                [0.7, 'rgba(170,220,50,0.85)'],
                [0.85, 'rgba(212,235,30,0.92)'],
                [1.0, 'rgba(253,231,37,1)']
            ],
            magma: [
                [0.0, 'rgba(0,0,0,0)'],
                [0.1, 'rgba(0,0,4,0.4)'],
                [0.25, 'rgba(59,15,112,0.55)'],
                [0.4, 'rgba(140,41,129,0.65)'],
                [0.55, 'rgba(222,73,104,0.75)'],
                [0.7, 'rgba(254,161,110,0.85)'],
                [0.85, 'rgba(254,220,175,0.92)'],
                [1.0, 'rgba(252,253,191,1)']
            ],
            cool: [
                [0.0, 'rgba(0,0,0,0)'],
                [0.1, 'rgba(13,8,135,0.4)'],
                [0.25, 'rgba(83,2,163,0.55)'],
                [0.4, 'rgba(139,10,165,0.65)'],
                [0.55, 'rgba(185,50,137,0.75)'],
                [0.7, 'rgba(219,92,104,0.85)'],
                [0.85, 'rgba(244,136,73,0.92)'],
                [1.0, 'rgba(254,189,42,1)']
            ]
        };

        let currentColormap = 'default';

        const defaults = {
            speed: 1000,
            intensity: 100,
            radius: 100,
            colormap: 'default'
        };

        function updateSliderFill(slider) {
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            const val = parseFloat(slider.value);
            const percentage = ((val - min) / (max - min)) * 100;
            slider.style.background = `linear-gradient(to right, #4ecdc4 ${percentage}%, rgba(255, 255, 255, 0.2) ${percentage}%)`;
        }

        function applyColormap(colormapName) {
            if (!map.getLayer('density-heatmap')) return;

            const colormap = COLORMAPS[colormapName] || COLORMAPS.default;
            const colorExpr = ['interpolate', ['linear'], ['heatmap-density']];

            colormap.forEach(([stop, color]) => {
                colorExpr.push(stop, color);
            });

            map.setPaintProperty('density-heatmap', 'heatmap-color', colorExpr);
            currentColormap = colormapName;
        }

        colormapBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const colormapName = btn.dataset.colormap;
                applyColormap(colormapName);

                colormapBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // Projection toggle
        const projectionBtns = document.querySelectorAll('.projection-btn');
        let currentProjection = 'globe';

        projectionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const projection = btn.dataset.projection;
                if (projection === currentProjection) return;

                currentProjection = projection;
                projectionBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                map.setProjection(projection);
            });
        });

        // Density layer toggle
        const densityToggle = document.getElementById('densityToggle');
        let densityVisible = true;

        densityToggle.addEventListener('change', () => {
            densityVisible = densityToggle.checked;
            if (map.getLayer('density-heatmap')) {
                map.setLayoutProperty('density-heatmap', 'visibility', densityVisible ? 'visible' : 'none');
            }
        });

        // Basemap toggle
        const basemapBtns = document.querySelectorAll('.basemap-btn');
        let currentBasemap = 'custom';

        const BASEMAP_STYLES = {
            satellite: 'mapbox://styles/mapbox/satellite-v9',
            custom: 'mapbox://styles/qtyree/cmkq3f00c003001qs2qib3wlr'
        };

        function setBathymetryLayer(show) {
            if (show) {
                // Add bathymetry raster source if not exists
                if (!map.getSource('bathymetry')) {
                    map.addSource('bathymetry', {
                        type: 'raster',
                        tiles: [
                            'https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}'
                        ],
                        tileSize: 256,
                        attribution: 'Esri, GEBCO, NOAA'
                    });
                }
                // Add bathymetry layer below heatmap if not exists
                if (!map.getLayer('bathymetry-layer')) {
                    const layers = map.getStyle().layers;
                    let firstSymbolId;
                    for (const layer of layers) {
                        if (layer.id === 'density-heatmap') {
                            firstSymbolId = layer.id;
                            break;
                        }
                    }
                    map.addLayer({
                        id: 'bathymetry-layer',
                        type: 'raster',
                        source: 'bathymetry',
                        paint: {
                            'raster-opacity': 0.85
                        }
                    }, firstSymbolId);
                } else {
                    map.setLayoutProperty('bathymetry-layer', 'visibility', 'visible');
                }
            } else {
                if (map.getLayer('bathymetry-layer')) {
                    map.setLayoutProperty('bathymetry-layer', 'visibility', 'none');
                }
            }
        }

        function addDataLayers() {
            // Add density heatmap source and layer
            if (!map.getSource('density-points')) {
                map.addSource('density-points', {
                    type: 'vector',
                    url: TILESET_URL
                });
            }

            if (!map.getLayer('density-heatmap')) {
                map.addLayer({
                    'id': 'density-heatmap',
                    'type': 'heatmap',
                    'source': 'density-points',
                    'source-layer': SOURCE_LAYER,
                    'maxzoom': 9,
                    'paint': {
                        'heatmap-weight': [
                            'interpolate', ['exponential', 1.5], ['get', 'density'],
                            1, 0.3, 2, 0.45, 3, 0.55, 4, 0.65, 5, 0.75, 6, 0.85, 7, 0.92, 8, 1.0
                        ],
                        'heatmap-intensity': ['interpolate', ['linear'], ['zoom'], 0, 1.0, 5, 1.5, 8, 2.0],
                        'heatmap-color': COLORMAPS[currentColormap] ?
                            ['interpolate', ['linear'], ['heatmap-density'], ...COLORMAPS[currentColormap].flat()] :
                            ['interpolate', ['linear'], ['heatmap-density'],
                                0.0, 'rgba(0,0,0,0)', 0.1, 'rgba(0,0,80,0.3)', 0.25, 'rgba(0,100,255,0.5)',
                                0.4, 'rgba(0,200,255,0.65)', 0.55, 'rgba(100,255,200,0.75)',
                                0.7, 'rgba(255,220,0,0.85)', 0.85, 'rgba(255,100,0,0.95)', 1.0, 'rgba(255,0,150,1)'
                            ],
                        'heatmap-radius': ['interpolate', ['linear'], ['zoom'], 0, 3, 4, 15, 8, 30],
                        'heatmap-opacity': 0.85
                    },
                    'filter': ['in', ['get', 'bin'], ['literal', [binA, binB]]]
                });
            }

            // Add whale locations
            if (!map.getSource('whale-locations')) {
                const whaleGeoJSON = {
                    type: 'FeatureCollection',
                    features: WHALE_WATCHING_LOCATIONS.map((loc, idx) => ({
                        type: 'Feature',
                        geometry: { type: 'Point', coordinates: loc.coordinates },
                        properties: { index: idx }
                    }))
                };
                map.addSource('whale-locations', { type: 'geojson', data: whaleGeoJSON });
            }

            if (!map.getLayer('whale-locations-halo')) {
                map.addLayer({
                    id: 'whale-locations-halo',
                    type: 'circle',
                    source: 'whale-locations',
                    paint: {
                        'circle-radius': ['interpolate', ['linear'], ['zoom'], 0, 6, 4, 8, 8, 10],
                        'circle-color': 'rgba(0,0,0,0.3)',
                        'circle-stroke-width': 0
                    }
                });
            }

            if (!map.getLayer('whale-locations-layer')) {
                map.addLayer({
                    id: 'whale-locations-layer',
                    type: 'circle',
                    source: 'whale-locations',
                    paint: {
                        'circle-radius': ['interpolate', ['linear'], ['zoom'], 0, 4, 4, 5, 8, 7],
                        'circle-color': '#000000',
                        'circle-stroke-color': '#ffffff',
                        'circle-stroke-width': 1.5
                    }
                });
            }
        }

        function switchBasemap(basemap) {
            if (basemap === currentBasemap) return;

            const prevBasemap = currentBasemap;
            currentBasemap = basemap;

            if (basemap === 'bathymetry') {
                // For bathymetry, keep satellite base and add overlay
                if (prevBasemap === 'custom') {
                    map.setStyle(BASEMAP_STYLES.satellite);
                    map.once('style.load', () => {
                        addDataLayers();
                        setBathymetryLayer(true);
                    });
                } else {
                    setBathymetryLayer(true);
                }
            } else if (basemap === 'satellite') {
                if (prevBasemap === 'custom') {
                    map.setStyle(BASEMAP_STYLES.satellite);
                    map.once('style.load', () => {
                        addDataLayers();
                    });
                } else {
                    setBathymetryLayer(false);
                }
            } else if (basemap === 'custom') {
                setBathymetryLayer(false);
                map.setStyle(BASEMAP_STYLES.custom);
                map.once('style.load', () => {
                    addDataLayers();
                });
            }
        }

        basemapBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const basemap = btn.dataset.basemap;
                basemapBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                switchBasemap(basemap);
            });
        });

        speedSlider.addEventListener('input', () => {
            const value = parseInt(speedSlider.value);
            morphDuration = value;
            const label = (value / 1000).toFixed(1) + 's';
            speedValue.textContent = label;
            updateSliderFill(speedSlider);

            if (mobileSpeedSlider) {
                mobileSpeedSlider.value = value;
                if (mobileSpeedVal) mobileSpeedVal.textContent = label;
            }
        });

        intensitySlider.addEventListener('input', () => {
            const value = parseInt(intensitySlider.value);
            intensityValue.textContent = value + '%';
            updateSliderFill(intensitySlider);

            if (map.getLayer('density-heatmap')) {
                const intensityMultiplier = value / 100;
                map.setPaintProperty('density-heatmap', 'heatmap-intensity', [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    0, 1.0 * intensityMultiplier,
                    5, 1.5 * intensityMultiplier,
                    8, 2.0 * intensityMultiplier
                ]);
            }
        });

        radiusSlider.addEventListener('input', () => {
            const value = parseInt(radiusSlider.value);
            radiusValue.textContent = value + '%';
            updateSliderFill(radiusSlider);

            if (map.getLayer('density-heatmap')) {
                const radiusMultiplier = value / 100;
                map.setPaintProperty('density-heatmap', 'heatmap-radius', [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    0, 3 * radiusMultiplier,
                    4, 15 * radiusMultiplier,
                    8, 30 * radiusMultiplier
                ]);
            }
        });

        resetSettings.addEventListener('click', () => {
            speedSlider.value = defaults.speed;
            morphDuration = defaults.speed;
            speedValue.textContent = '1.0s';
            updateSliderFill(speedSlider);
            if (mobileSpeedSlider) {
                mobileSpeedSlider.value = defaults.speed;
                if (mobileSpeedVal) mobileSpeedVal.textContent = '1.0s';
            }

            applyColormap(defaults.colormap);
            colormapBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.colormap === defaults.colormap);
            });

            intensitySlider.value = defaults.intensity;
            intensityValue.textContent = '100%';
            updateSliderFill(intensitySlider);
            if (map.getLayer('density-heatmap')) {
                map.setPaintProperty('density-heatmap', 'heatmap-intensity', [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    0, 1.0,
                    5, 1.5,
                    8, 2.0
                ]);
            }

            radiusSlider.value = defaults.radius;
            radiusValue.textContent = '100%';
            updateSliderFill(radiusSlider);
            if (map.getLayer('density-heatmap')) {
                map.setPaintProperty('density-heatmap', 'heatmap-radius', [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    0, 3,
                    4, 15,
                    8, 30
                ]);
            }

            // Reset projection to globe
            currentProjection = 'globe';
            map.setProjection('globe');
            projectionBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.projection === 'globe');
            });

            // Reset basemap to terrain (custom)
            if (currentBasemap !== 'custom') {
                switchBasemap('custom');
            }
            basemapBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.basemap === 'custom');
            });

            // Reset density layer visibility
            densityVisible = true;
            densityToggle.checked = true;
            if (map.getLayer('density-heatmap')) {
                map.setLayoutProperty('density-heatmap', 'visibility', 'visible');
            }
        });

        // Mobile nav toggle
        const navbar = document.getElementById('navbar');
        const navToggle = navbar ? navbar.querySelector('.nav-toggle') : null;
        if (navToggle && navbar) {
            navToggle.addEventListener('click', () => {
                navbar.classList.toggle('nav-open');
            });

            navbar.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => navbar.classList.remove('nav-open'));
            });
        }

        // Initialize slider fills
        document.addEventListener('DOMContentLoaded', () => {
            updateSliderFill(speedSlider);
            updateSliderFill(intensitySlider);
            updateSliderFill(radiusSlider);
            if (mobileSpeedSlider && mobileSpeedVal) {
                mobileSpeedSlider.value = speedSlider.value;
                mobileSpeedVal.textContent = speedValue.textContent;
            }
        });

        // ============================================================
        // MOBILE UI INTERACTIONS
        // ============================================================

        // Mobile description button toggle
        const mobileDescBtn = document.getElementById('mobileDescBtn');
        const mobileDescPanel = document.getElementById('mobileDescPanel');

        if (mobileDescBtn && mobileDescPanel) {
            mobileDescBtn.addEventListener('click', () => {
                mobileDescPanel.classList.toggle('open');
                mobileDescBtn.classList.toggle('active');
            });

            // Close panel when clicking outside
            document.addEventListener('click', (e) => {
                if (!mobileDescBtn.contains(e.target) && !mobileDescPanel.contains(e.target)) {
                    mobileDescPanel.classList.remove('open');
                    mobileDescBtn.classList.remove('active');
                }
            });
        }

        // Mobile basemap select dropdown
        const mobileBasemapSelect = document.getElementById('mobileBasemapSelect');

        if (mobileBasemapSelect) {
            mobileBasemapSelect.addEventListener('change', () => {
                const basemap = mobileBasemapSelect.value;
                // Sync with desktop
                switchBasemap(basemap);
                basemapBtns.forEach(b => b.classList.toggle('active', b.dataset.basemap === basemap));
            });
        }

        // Mobile intensity slider
        const mobileIntensitySlider = document.getElementById('mobileIntensitySlider');
        const mobileIntensityVal = document.getElementById('mobileIntensityVal');

        if (mobileIntensitySlider) {
            mobileIntensitySlider.addEventListener('input', () => {
                const val = parseInt(mobileIntensitySlider.value);
                mobileIntensityVal.textContent = val + '%';
                // Sync with desktop
                intensitySlider.value = val;
                intensityValue.textContent = val + '%';
                updateSliderFill(intensitySlider);
                const factor = val / 100;
                if (map.getLayer('density-heatmap')) {
                    map.setPaintProperty('density-heatmap', 'heatmap-intensity', [
                        'interpolate', ['linear'], ['zoom'],
                        0, 1.0 * factor, 5, 1.5 * factor, 8, 2.0 * factor
                    ]);
                }
            });
        }

        // Mobile radius slider
        const mobileRadiusSlider = document.getElementById('mobileRadiusSlider');
        const mobileRadiusVal = document.getElementById('mobileRadiusVal');

        if (mobileRadiusSlider) {
            mobileRadiusSlider.addEventListener('input', () => {
                const val = parseInt(mobileRadiusSlider.value);
                mobileRadiusVal.textContent = val + '%';
                // Sync with desktop
                radiusSlider.value = val;
                radiusValue.textContent = val + '%';
                updateSliderFill(radiusSlider);
                const factor = val / 100;
                if (map.getLayer('density-heatmap')) {
                    map.setPaintProperty('density-heatmap', 'heatmap-radius', [
                        'interpolate', ['linear'], ['zoom'],
                        0, 3 * factor, 4, 15 * factor, 8, 30 * factor
                    ]);
                }
            });
        }

        if (mobileSpeedSlider) {
            mobileSpeedSlider.addEventListener('input', () => {
                const speed = parseInt(mobileSpeedSlider.value);
                morphDuration = speed;
                const label = (speed / 1000).toFixed(1) + 's';
                speedSlider.value = speed;
                speedValue.textContent = label;
                if (mobileSpeedVal) mobileSpeedVal.textContent = label;
                updateSliderFill(speedSlider);
            });
        }

        // Mobile colormap buttons
        const mobileColormapBtns = document.querySelectorAll('.mobile-colormap-btn');
        mobileColormapBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const colormap = btn.dataset.colormap;
                mobileColormapBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                // Sync with desktop
                applyColormap(colormap);
                colormapBtns.forEach(b => b.classList.toggle('active', b.dataset.colormap === colormap));
            });
        });

        // Mobile density toggle
        const mobileDensityToggle = document.getElementById('mobileDensityToggle');
        if (mobileDensityToggle) {
            mobileDensityToggle.addEventListener('change', () => {
                densityVisible = mobileDensityToggle.checked;
                // Sync with desktop toggle
                densityToggle.checked = densityVisible;
                if (map.getLayer('density-heatmap')) {
                    map.setLayoutProperty('density-heatmap', 'visibility', densityVisible ? 'visible' : 'none');
                }
            });
        }

        // Move circular controls to mobile panel on resize
        function handleMobileLayout() {
            const controls = document.getElementById('controls');
            const mobileSliderContainer = document.getElementById('mobileSliderContainer');
            const mapElement = document.getElementById('map');

            if (window.innerWidth <= 900) {
                // Move controls to mobile panel
                if (controls && mobileSliderContainer && !mobileSliderContainer.contains(controls)) {
                    mobileSliderContainer.appendChild(controls);
                }
            } else {
                // Move controls back to map
                if (controls && mapElement && !mapElement.contains(controls)) {
                    mapElement.appendChild(controls);
                }
            }
        }

        // Run on load and resize
        handleMobileLayout();
        window.addEventListener('resize', handleMobileLayout);

        // ============================================================
        // LOADING ANIMATION & WELCOME MODAL HANDLER
        // ============================================================
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingVideo = document.getElementById('loadingVideo');
        const welcomeModal = document.getElementById('welcomeModal');
        const welcomeBtn = document.getElementById('welcomeBtn');
        const welcomeLoading = document.getElementById('welcomeLoading');

        let mapIsReady = false;
        let videoEnded = false;

        function updateWelcomeButton() {
            if (welcomeBtn && welcomeLoading) {
                if (mapIsReady) {
                    welcomeBtn.disabled = false;
                    welcomeBtn.textContent = 'Explore the Map';
                    welcomeLoading.classList.add('ready');
                    welcomeLoading.querySelector('span').textContent = 'Map ready!';
                } else {
                    welcomeBtn.disabled = true;
                    welcomeBtn.textContent = 'Loading map...';
                    welcomeLoading.classList.remove('ready');
                    welcomeLoading.querySelector('span').textContent = 'Preparing map data...';
                }
            }
        }

        function dismissWelcome() {
            if (welcomeModal) {
                welcomeModal.classList.add('hidden');
            }
        }

        // Mark map as ready when fully loaded
        map.on('idle', function onFirstIdle() {
            mapIsReady = true;
            updateWelcomeButton();
            map.off('idle', onFirstIdle);
        });

        if (loadingVideo && loadingOverlay) {
            // Hide loading overlay when video ends (welcome modal takes over)
            loadingVideo.addEventListener('ended', () => {
                videoEnded = true;
                loadingOverlay.classList.add('hidden');
                updateWelcomeButton();
            });

            // Fallback: hide after video duration + buffer
            loadingVideo.addEventListener('loadedmetadata', () => {
                const duration = loadingVideo.duration * 1000 + 500;
                setTimeout(() => {
                    if (!videoEnded) {
                        videoEnded = true;
                        loadingOverlay.classList.add('hidden');
                        updateWelcomeButton();
                    }
                }, duration);
            });

            // If video fails to load, hide overlay after 3 seconds
            loadingVideo.addEventListener('error', () => {
                setTimeout(() => {
                    videoEnded = true;
                    loadingOverlay.classList.add('hidden');
                    updateWelcomeButton();
                }, 3000);
            });

            // Skip animation on click/tap
            loadingOverlay.addEventListener('click', () => {
                videoEnded = true;
                loadingOverlay.classList.add('hidden');
                updateWelcomeButton();
            });
        }

        // Welcome modal button
        if (welcomeBtn) {
            welcomeBtn.addEventListener('click', () => {
                if (mapIsReady) {
                    dismissWelcome();
                }
            });
        }

        // Allow clicking outside content to dismiss (if map is ready)
        if (welcomeModal) {
            welcomeModal.addEventListener('click', (e) => {
                if (e.target === welcomeModal && mapIsReady) {
                    dismissWelcome();
                }
            });
        }

        // Escape key to dismiss welcome modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && mapIsReady && welcomeModal && !welcomeModal.classList.contains('hidden')) {
                dismissWelcome();
            }
        });
    </script>
</body>
</html>
