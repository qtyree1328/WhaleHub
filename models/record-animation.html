<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Record Whale Animation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            /* Bright green for chroma keying */
            background: #00FF00;
            min-height: 100vh;
            overflow: hidden;
        }

        .scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        model-viewer {
            width: 100vw;
            height: 100vh;
            background: transparent;
            --progress-bar-color: transparent;
            --progress-bar-height: 0;
        }

        /* Recording controls */
        .record-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
            padding: 15px 20px;
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
        }

        .record-btn {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .record-btn.play {
            background: #4a9eff;
            color: white;
        }

        .record-btn.reset {
            background: #666;
            color: white;
        }

        .status {
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }

        .status-dot.ready { background: #4a9eff; }
        .status-dot.playing { background: #00ff00; animation: pulse 0.5s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .hide-controls .record-controls {
            display: none;
        }
    </style>
</head>
<body>
    <div class="scene-container">
        <model-viewer
            id="whale"
            src="humpback_whale.glb"
            camera-controls="false"
            autoplay
            shadow-intensity="0"
            exposure="1.2"
            camera-orbit="11deg 83deg 41.5m"
            camera-target="-1m 8.8m 0m"
            field-of-view="45deg"
            interaction-prompt="none"
            disable-zoom
            disable-pan
            disable-tap>
        </model-viewer>
    </div>

    <div class="record-controls">
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Loading...</span>
        </div>
        <button class="record-btn play" id="playBtn" disabled>Play Animation</button>
        <button class="record-btn reset" id="resetBtn">Reset</button>
        <button class="record-btn reset" id="hideBtn">Hide Controls (H)</button>
    </div>

    <script>
        const whale = document.getElementById('whale');
        const playBtn = document.getElementById('playBtn');
        const resetBtn = document.getElementById('resetBtn');
        const hideBtn = document.getElementById('hideBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // Your settings from the editor
        const settings = {
            camera: { orbit: 11, pitch: 83, distance: 41.5, fov: 45 },
            offset: { x: -1, y: 8.8, z: 0 },
            rotation: { yaw: 3, pitch: -11, roll: 27 },
            clip: { start: 4, end: 6 },
            transition: {
                totalDuration: 6.5,
                whaleInStart: 0,
                whaleInEnd: 0.559,
                whaleOutStart: 1.707,
                whaleOutEnd: 3.165
            }
        };

        let isPlaying = false;
        let animationStart = null;

        whale.addEventListener('load', () => {
            console.log('Model loaded');

            // Apply rotation (yaw, pitch, roll)
            whale.orientation = `${settings.rotation.yaw}deg ${settings.rotation.pitch}deg ${settings.rotation.roll}deg`;

            // Wait for animation data then set clip position
            setTimeout(() => {
                whale.currentTime = settings.clip.start;
                whale.pause();

                // Start invisible (for fade in)
                whale.style.opacity = '0';

                statusDot.classList.add('ready');
                statusText.textContent = 'Ready - Press Play or Spacebar';
                playBtn.disabled = false;
            }, 300);
        });

        function applyEffects(currentTime) {
            const { whaleInStart, whaleInEnd, whaleOutStart, whaleOutEnd } = settings.transition;
            let opacity = 1;

            if (currentTime < whaleInStart) {
                opacity = 0;
            } else if (currentTime >= whaleInStart && currentTime < whaleInEnd) {
                opacity = (currentTime - whaleInStart) / (whaleInEnd - whaleInStart);
            } else if (currentTime >= whaleInEnd && currentTime < whaleOutStart) {
                opacity = 1;
            } else if (currentTime >= whaleOutStart && currentTime < whaleOutEnd) {
                opacity = 1 - (currentTime - whaleOutStart) / (whaleOutEnd - whaleOutStart);
            } else {
                opacity = 0;
            }

            whale.style.opacity = opacity.toString();
        }

        function animate(timestamp) {
            if (!isPlaying) return;

            if (!animationStart) {
                animationStart = timestamp;
                whale.play();
            }

            const elapsed = (timestamp - animationStart) / 1000;
            const currentTime = elapsed;

            // Update whale animation time within clip range
            const clipDuration = settings.clip.end - settings.clip.start;
            const clipProgress = (currentTime / settings.transition.totalDuration);
            whale.currentTime = settings.clip.start + (clipDuration * clipProgress);

            applyEffects(currentTime);

            // Update status
            statusText.textContent = `Playing: ${currentTime.toFixed(1)}s / ${settings.transition.totalDuration}s`;

            if (currentTime >= settings.transition.totalDuration) {
                stopAnimation();
                statusText.textContent = 'Complete - Press Reset to replay';
                return;
            }

            requestAnimationFrame(animate);
        }

        function startAnimation() {
            if (isPlaying) return;
            isPlaying = true;
            animationStart = null;
            statusDot.classList.remove('ready');
            statusDot.classList.add('playing');
            playBtn.textContent = 'Playing...';
            playBtn.disabled = true;
            requestAnimationFrame(animate);
        }

        function stopAnimation() {
            isPlaying = false;
            whale.pause();
            statusDot.classList.remove('playing');
            statusDot.classList.add('ready');
            playBtn.textContent = 'Play Animation';
            playBtn.disabled = false;
        }

        function resetAnimation() {
            stopAnimation();
            animationStart = null;
            whale.currentTime = settings.clip.start;
            whale.style.opacity = '0';
            statusText.textContent = 'Ready - Press Play or Spacebar';
        }

        playBtn.addEventListener('click', startAnimation);
        resetBtn.addEventListener('click', resetAnimation);
        hideBtn.addEventListener('click', () => {
            document.body.classList.toggle('hide-controls');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (!isPlaying) startAnimation();
            } else if (e.code === 'KeyR') {
                resetAnimation();
            } else if (e.code === 'KeyH') {
                document.body.classList.toggle('hide-controls');
            }
        });
    </script>
</body>
</html>
