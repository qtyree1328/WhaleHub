
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Location Details - Whale Watching Atlas</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.js"></script>
    <script src="whale-species.js"></script>
    <script src="whale-locations.js"></script>
    <script src="config.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        :root { --primary: #0a4a7c; --primary-light: #1a6db0; --accent: #00c9a7; --text: #1a2b3c; --text-muted: #5a6d7e; --surface: #ffffff; --surface-alt: #f8fafc; --border: #e2e8f0; --radius-sm: 6px; --radius-md: 10px; --radius-lg: 16px; --shadow-md: 0 4px 12px rgba(0,0,0,0.1); --transition-fast: 0.15s ease; --transition-base: 0.25s ease; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #f1f5f9; color: var(--text); line-height: 1.6; padding-top: 0; }
        #navbar { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); padding: 0 24px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; height: 64px; }
        .nav-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; color: white; font-weight: 700; font-size: 18px; }
        .whale-icon { font-size: 28px; }
        .nav-links { display: flex; gap: 8px; }
        .nav-link { color: rgba(255,255,255,0.85); text-decoration: none; padding: 8px 16px; border-radius: 8px; font-weight: 500; font-size: 14px; transition: all var(--transition-fast); }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: white; }
        #navbar .nav-toggle { display: none; width: 38px; height: 38px; border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; background: rgba(0,0,0,0.1); color: #fff; align-items: center; justify-content: center; gap: 6px; flex-direction: column; cursor: pointer; }
        #navbar .nav-toggle span { display: block; width: 18px; height: 2px; background: currentColor; border-radius: 4px; }
        .location-detail { max-width: 1400px; margin: 0 auto; padding: 0 24px 48px; }
        .location-hero { position: relative; height: 450px; margin: 0 -24px 32px; overflow: hidden; background: #1a2b3c; }
        .location-hero-image { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s ease; }
        .location-hero-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.3) 40%, transparent 100%); }
        .location-hero-content { position: absolute; bottom: 0; left: 0; right: 0; padding: 40px; color: white; }
        .location-hero-region { display: inline-flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 500; background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px; margin-bottom: 16px; backdrop-filter: blur(8px); }
        .location-hero-title { font-size: 52px; font-weight: 700; margin: 0 0 12px 0; letter-spacing: -0.03em; text-shadow: 0 2px 20px rgba(0,0,0,0.3); }
        .location-hero-tagline { font-size: 18px; opacity: 0.9; max-width: 700px; }
        .location-hero-scores { position: absolute; top: 24px; right: 24px; display: flex; gap: 12px; }
        .hero-score { text-align: center; background: rgba(0,0,0,0.5); padding: 16px 20px; border-radius: var(--radius-md); backdrop-filter: blur(12px); }
        .hero-score-value { font-size: 32px; font-weight: 700; color: white; }
        .hero-score-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: rgba(255,255,255,0.8); margin-top: 4px; }
        .hero-score.experience .hero-score-value { color: #FF6B6B; }
        .hero-score.sighting .hero-score-value { color: #4CAF50; }
        .location-back-link { position: absolute; top: 24px; left: 24px; display: flex; align-items: center; gap: 8px; color: white; text-decoration: none; font-weight: 500; font-size: 14px; padding: 10px 16px; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); border-radius: var(--radius-md); transition: all var(--transition-base); }
        .location-back-link:hover { background: rgba(0,0,0,0.5); transform: translateX(-4px); }
        .location-content { display: grid; grid-template-columns: 2fr 1fr; gap: 32px; }
        @media (max-width: 960px) { .location-content { grid-template-columns: 1fr; } }
        .location-main { display: flex; flex-direction: column; gap: 24px; }
        .location-section { background: var(--surface); border-radius: var(--radius-lg); padding: 28px; box-shadow: var(--shadow-md); }
        .section-title { font-size: 18px; font-weight: 700; color: var(--primary); margin: 0 0 20px 0; padding-bottom: 12px; border-bottom: 2px solid var(--border); }
        .species-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .species-item { display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--surface-alt); border-radius: var(--radius-md); border: 1px solid var(--border); transition: all var(--transition-fast); }
        .species-item:hover { border-color: var(--primary-light); transform: translateY(-2px); }
        .species-name { font-weight: 600; color: var(--text); font-size: 14px; }
        .species-season { font-size: 12px; color: var(--text-muted); }
        .monthly-chart { margin-top: 8px; }
        .monthly-density-chart { margin-top: 8px; padding: 12px 14px 10px; border-radius: 10px; background: #fdfdfd; border: 1px solid rgba(15, 23, 42, 0.08); }
        .monthly-density-chart .chart-title { font-size: 13px; font-weight: 600; color: #1f2933; margin-bottom: 8px; }
        .month-bars { display: grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap: 4px; align-items: flex-end; margin-bottom: 10px; }
        .month-bar { position: relative; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .bar-wrapper { width: 100%; height: 60px; border-radius: 999px; background: linear-gradient(to top, rgba(148, 163, 184, 0.20), rgba(148, 163, 184, 0.05)); overflow: hidden; position: relative; }
        .stacked-bar { position: absolute; bottom: 0; left: 0; right: 0; display: flex; flex-direction: column; justify-content: flex-end; border-radius: 999px; overflow: hidden; }
        .species-segment { width: 100%; }
        .bar-count { font-size: 11px; font-weight: 600; color: #111827; }
        .bar-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.04em; color: #6b7280; }
        .month-tooltip { position: absolute; bottom: 72px; left: 50%; transform: translateX(-50%); padding: 6px 8px; border-radius: 8px; background: rgba(15, 23, 42, 0.97); color: white; font-size: 11px; white-space: nowrap; box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45); opacity: 0; pointer-events: none; transition: opacity 0.15s ease, transform 0.15s ease; z-index: 10; min-width: 140px; }
        .month-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border-width: 5px; border-style: solid; border-color: rgba(15, 23, 42, 0.97) transparent transparent transparent; }
        .month-bar:hover .month-tooltip { opacity: 1; transform: translateX(-50%) translateY(-2px); }
        .tooltip-title { font-weight: 600; margin-bottom: 2px; }
        .tooltip-species { display: flex; align-items: center; gap: 6px; margin-top: 1px; }
        .tooltip-color { width: 10px; height: 10px; border-radius: 999px; flex-shrink: 0; }
        .species-legend { display: flex; flex-wrap: wrap; gap: 6px 10px; margin-top: 2px; }
        .legend-item { display: inline-flex; align-items: center; gap: 6px; font-size: 10px; color: #4b5563; padding: 3px 6px; border-radius: 999px; background: rgba(148, 163, 184, 0.12); }
        .legend-color { width: 10px; height: 10px; border-radius: 999px; }
        .location-sidebar { display: flex; flex-direction: column; gap: 24px; }
        .quick-facts-card, .best-months-card { background: var(--surface); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-md); }
        .fact-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border); }
        .fact-item:last-child { border-bottom: none; padding-bottom: 0; }
        .fact-label { font-size: 13px; color: var(--text-muted); font-weight: 500; }
        .fact-value { font-size: 14px; color: var(--text); font-weight: 600; }
        .accessibility-badge { display: inline-flex; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .accessibility-excellent { background: #dcfce7; color: #16a34a; }
        .accessibility-good { background: #e0f2fe; color: #0284c7; }
        .accessibility-moderate { background: #fef3c7; color: #d97706; }
        .months-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .month-badge { text-align: center; padding: 10px 8px; border-radius: var(--radius-sm); font-size: 12px; font-weight: 600; background: var(--surface-alt); color: var(--text-muted); border: 1px solid var(--border); }
        .month-badge.active { background: var(--accent); color: white; border-color: var(--accent); }
        .location-map-card { background: var(--surface); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-md); position: relative; transition: all 0.3s ease; }
        .location-map-card.expanded { position: fixed; top: 64px; left: 0; right: 0; bottom: 0; z-index: 100; border-radius: 0; margin: 0; }
        .location-map-card.expanded .location-map-container { height: calc(100vh - 64px - 56px) !important; }
        .location-map-header { padding: 12px 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
        .location-map-header h3 { font-size: 14px; font-weight: 600; margin: 0; text-transform: uppercase; letter-spacing: 0.05em; }
        .map-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .map-view-toggle { display: flex; background: rgba(255,255,255,0.2); border-radius: 6px; overflow: hidden; }
        .map-view-btn { padding: 6px 12px; border: none; background: transparent; color: rgba(255,255,255,0.8); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .map-view-btn.active { background: rgba(255,255,255,0.3); color: white; }
        .map-view-btn:hover:not(.active) { background: rgba(255,255,255,0.15); }
        .year-select { padding: 6px 10px; border: none; border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 11px; font-weight: 600; cursor: pointer; appearance: none; padding-right: 24px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; }
        .year-select option { background: #0a4a7c; color: white; }
        .year-select.hidden { display: none; }
        .map-month-control { display: flex; align-items: center; gap: 8px; }
        .map-month-label { font-size: 11px; font-weight: 600; min-width: 28px; text-align: center; }
        .map-month-slider { width: 80px; height: 4px; -webkit-appearance: none; background: rgba(255,255,255,0.3); border-radius: 2px; cursor: pointer; }
        .map-month-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: white; border-radius: 50%; cursor: pointer; }
        .map-month-slider::-moz-range-thumb { width: 14px; height: 14px; background: white; border-radius: 50%; cursor: pointer; border: none; }
        .expand-btn { padding: 6px 10px; border: none; border-radius: 6px; background: rgba(255,255,255,0.2); color: white; font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .expand-btn:hover { background: rgba(255,255,255,0.3); }
        .location-map-container { height: 300px; position: relative; transition: height 0.3s ease; }
        .map-overlay-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .map-overlay-bg.visible { display: block; }
        .map-legend { position: absolute; bottom: 10px; left: 10px; background: rgba(255,255,255,0.95); padding: 10px 12px; border-radius: 8px; font-size: 11px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 5; }
        .map-legend.hidden { display: none; }
        .map-legend-title { font-weight: 600; margin-bottom: 6px; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .map-legend-close { display: none; background: none; border: none; font-size: 16px; color: #666; cursor: pointer; padding: 0 4px; line-height: 1; }
        .map-legend-item { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
        .map-legend-item:last-child { margin-bottom: 0; }
        .map-legend-color { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .map-legend-label { color: #555; }
        .map-legend-toggle { display: none; position: absolute; bottom: 10px; left: 10px; z-index: 6; background: rgba(255,255,255,0.95); border: none; border-radius: 6px; padding: 6px 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; font-size: 10px; font-weight: 600; color: #333; }
        .map-legend-toggle svg { width: 12px; height: 12px; margin-right: 4px; vertical-align: middle; }
        .map-legend-toggle.active { background: var(--primary); color: white; }
        @media (max-width: 768px) {
            .map-legend-toggle { display: inline-flex; align-items: center; }
            .map-legend { transform: translateY(calc(100% + 20px)); transition: transform 0.2s ease; }
            .map-legend.mobile-visible { transform: translateY(0); }
            .map-legend-close { display: block; }
        }
        .mapboxgl-popup-content { padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .description-text p {margin: 0 0 1rem 0;   /* bottom space between paragraphs */}

        .popup-title { font-weight: 600; font-size: 14px; color: #1a2b3c; margin-bottom: 6px; }
        .popup-row { font-size: 12px; color: #5a6d7e; margin-bottom: 2px; }
        .popup-row:last-child { margin-bottom: 0; }
        .nearby-locations { display: flex; flex-direction: column; gap: 10px; }
        .nearby-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--surface-alt); border-radius: var(--radius-md); text-decoration: none; color: inherit; transition: all var(--transition-fast); }
        .nearby-item:hover { background: var(--border); transform: translateX(4px); }
        .nearby-distance { font-size: 11px; color: var(--text-muted); min-width: 60px; }
        .nearby-name { font-weight: 600; color: var(--text); font-size: 14px; }
        .nearby-region { font-size: 12px; color: var(--text-muted); }
        .description-text { font-size: 15px; line-height: 1.8; color: var(--text); }
        .photo-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        .gallery-item { position: relative; border-radius: var(--radius-md); overflow: hidden; aspect-ratio: 4/3; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all var(--transition-fast); }
        .gallery-item:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        .gallery-item:hover img { transform: scale(1.05); }
        .gallery-lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; }
        .gallery-lightbox.active { display: flex; }
        .lightbox-content { position: relative; max-width: 90vw; max-height: 90vh; }
        .lightbox-content img { max-width: 100%; max-height: 90vh; border-radius: var(--radius-md); }
        .lightbox-close { position: absolute; top: -40px; right: 0; background: none; border: none; color: white; font-size: 32px; cursor: pointer; padding: 8px; opacity: 0.8; transition: opacity 0.2s; }
        .lightbox-close:hover { opacity: 1; }
        .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(8px); transition: all 0.2s; }
        .lightbox-nav:hover { background: rgba(255,255,255,0.3); }
        .lightbox-nav.prev { left: -70px; }
        .lightbox-nav.next { right: -70px; }
        .lightbox-counter { position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); color: white; font-size: 14px; font-weight: 500; }
        @media (max-width: 768px) {
            .location-hero { height: 350px; }
            .location-hero-title { font-size: 32px; }
            .location-hero-tagline { font-size: 15px; }
            .location-hero-content { padding: 24px; }
            .species-grid { grid-template-columns: 1fr; }
            #navbar .nav-links { display: none; position: absolute; top: 64px; left: 0; right: 0; padding: 12px 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); flex-direction: column; gap: 8px; box-shadow: 0 10px 24px rgba(0,0,0,0.35); }
            #navbar.nav-open .nav-links { display: flex; }
            #navbar .nav-toggle { display: inline-flex; }
            #navbar .nav-links .nav-link { width: 100%; text-align: left; }

            /* Smaller hero score boxes on mobile */
            .location-hero-scores { gap: 8px; top: 16px; right: 16px; }
            .hero-score { padding: 10px 14px; min-width: 70px; }
            .hero-score-value { font-size: 20px; }
            .hero-score-label { font-size: 9px; }

            /* Fix expanded map - smaller like whale page */
            .location-map-card.expanded {
                top: 23vh !important;
                bottom: 10vh !important;
                left: 8px !important;
                right: 8px !important;
            }
            .location-map-card.expanded .location-map-header {
                padding: 6px 10px;
                gap: 6px;
            }
            .location-map-card.expanded .location-map-header h3 {
                font-size: 10px;
                display: none; /* Hide title to save space */
            }
            .location-map-card.expanded .map-controls {
                width: 100%;
                justify-content: space-between;
                gap: 4px;
            }
            .location-map-card.expanded .map-view-toggle { font-size: 9px; }
            .location-map-card.expanded .map-view-btn { padding: 3px 6px; font-size: 9px; }
            .location-map-card.expanded .year-select { padding: 2px 4px; font-size: 9px; max-width: 70px; }
            .location-map-card.expanded .map-month-control { gap: 2px; }
            .location-map-card.expanded .map-month-label { font-size: 9px; min-width: 22px; padding: 2px 4px; }
            .location-map-card.expanded .map-month-slider { width: 40px; }
            .location-map-card.expanded .expand-btn { padding: 3px 6px; font-size: 9px; }
            .location-map-card.expanded .expand-btn svg { width: 10px; height: 10px; }
            .location-map-card.expanded .location-map-container {
                height: calc(100vh - 56px - 40px) !important; /* navbar + header */
            }
        }
    </style>
</head>
<body>
    <nav id="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <span class="whale-icon"><img src="favicon.ico" alt="Whale Icon" class="whale-icon-img"></span>
                <span class="brand-text">Whale Watching Atlas</span>
            </a>
            <button class="nav-toggle" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-links">
                <a href="density-map.html" class="nav-link">Density Map</a>
                <a href="species.html" class="nav-link">Species Map</a>
                <a href="whale-species-gallery.html" class="nav-link">Whale Species</a>
                <a href="whale-locations-gallery.html" class="nav-link active">Locations</a>
                <a href="/news.html" class="nav-link">News</a>
                <a href="about.html" class="nav-link">About</a>
            </div>
        </div>
    </nav>
    <div class="map-overlay-bg" id="mapOverlay"></div>
    <div class="gallery-lightbox" id="galleryLightbox">
        <div class="lightbox-content">
            <button class="lightbox-close" id="lightboxClose">&times;</button>
            <button class="lightbox-nav prev" id="lightboxPrev"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></button>
            <img id="lightboxImage" src="" alt="">
            <button class="lightbox-nav next" id="lightboxNext"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button>
            <div class="lightbox-counter" id="lightboxCounter">1 / 1</div>
        </div>
    </div>
    <main class="location-detail">
        <div class="location-hero">
            <img class="location-hero-image" id="heroImage" src="" alt="">
            <div class="location-hero-overlay"></div>
            <a href="whale-locations-gallery.html" class="location-back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Back to Locations
            </a>
            <div class="location-hero-scores">
                <div class="hero-score experience"><div class="hero-score-value" id="experienceScore">--</div><div class="hero-score-label">Experience</div></div>
                <div class="hero-score sighting"><div class="hero-score-value" id="sightingScore">--</div><div class="hero-score-label">Sighting Rate</div></div>
            </div>
            <div class="location-hero-content">
                <span class="location-hero-region">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    <span id="regionName">Loading...</span>
                </span>
                <h1 class="location-hero-title" id="heroTitle">Loading...</h1>
                <p class="location-hero-tagline" id="heroTagline"></p>
            </div>
        </div>
        <div class="location-content">
            <div class="location-main">
                <section class="location-section" id="descriptionSection" style="display:none;"><h2 class="section-title">About This Location</h2><div class="description-text" id="locationDescription"></div></section>
                <section class="location-section" id="gallerySection" style="display:none;"><h2 class="section-title">Photo Gallery</h2><div class="photo-gallery" id="photoGallery"></div></section>
                <section class="location-section"><h2 class="section-title">Species You Can See</h2><div class="species-grid" id="speciesGrid"></div></section>
                <section class="location-section"><h2 class="section-title">Monthly Whale Activity</h2><div class="monthly-chart" id="monthlyChart"></div><p style="font-size: 13px; color: var(--text-muted); text-align: center; margin-top: 8px;">Higher bars indicate more whale activity.</p></section>
                <section class="location-section"><h2 class="section-title">Nearby Destinations</h2><div class="nearby-locations" id="nearbyLocations"></div></section>
            </div>
            <aside class="location-sidebar">
                <div class="quick-facts-card"><h3 class="section-title">Quick Facts</h3><div id="quickFacts"></div></div>
                <div class="best-months-card"><h3 class="section-title">Best Viewing Months</h3><div class="months-grid" id="monthsGrid"></div></div>
                <div class="location-map-card" id="mapCard">
                    <div class="location-map-header">
                        <h3>Species Sightings</h3>
                        <div class="map-controls" id="mapControls">
                            <div class="map-view-toggle"><button class="map-view-btn active" data-view="heatmap">Heatmap</button><button class="map-view-btn" data-view="points">Points</button></div>
                            <select class="year-select hidden" id="yearSelect"><option value="all">All Years</option></select>
                            <div class="map-month-control"><span class="map-month-label" id="mapMonthLabel">Jan</span><input type="range" min="1" max="12" value="1" class="map-month-slider" id="mapMonthSlider"></div>
                            <button class="expand-btn" id="expandBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>Expand</button>
                        </div>
                    </div>
                    <div class="location-map-container" id="mapContainer">
                        <button class="map-legend-toggle" id="mapLegendToggle">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
                            Legend
                        </button>
                        <div class="map-legend" id="mapLegend">
                            <div class="map-legend-title">
                                Species
                                <button class="map-legend-close" id="mapLegendClose">&times;</button>
                            </div>
                            <div id="legendItems"></div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </main>
    <script>
        const MONTH_ABBR = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const SPECIES_COLORS = {"Humpback whale": "#3498db", "Blue whale": "#2980b9", "Gray whale": "#7f8c8d", "Orca": "#2c3e50", "Fin whale": "#8e44ad", "Sperm whale": "#c0392b", "Minke whale": "#27ae60", "Southern right whale": "#d35400", "North Atlantic right whale": "#d35400", "Right whale": "#d35400", "Beluga whale": "#ecf0f1", "Sei whale": "#9b59b6", "Bryde's whale": "#1abc9c", "Pilot whale": "#34495e", "Beaked whale": "#f39c12", "default": "#95a5a6"};
        let currentImageIndex = 0, locationImages = [], galleryImages = [], densityMap = null, currentMapMonth = 1, currentView = 'heatmap', currentYear = 'all', isMapExpanded = false, availableYears = [], currentPopup = null, currentGalleryIndex = 0;

        function getSpeciesColor(name) { return name ? (SPECIES_COLORS[name] || SPECIES_COLORS.default) : SPECIES_COLORS.default; }
        function generateLocationId(name) { return name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, ''); }
        function getLocationId() { return new URLSearchParams(window.location.search).get('id'); }
        function findLocation(id) { return WHALE_WATCHING_LOCATIONS.find(loc => generateLocationId(loc.name) === id); }
        function formatVisitors(num) { if (!num) return 'N/A'; if (num >= 1000000) return (num / 1000000).toFixed(1) + ' million'; if (num >= 1000) return Math.round(num / 1000) + ',000'; return num.toLocaleString(); }
        function haversineDistance(lat1, lon1, lat2, lon2) { const R = 6371, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180, a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
        function findNearbyLocations(currentLocation, count = 4) { const [currentLon, currentLat] = currentLocation.coordinates; return WHALE_WATCHING_LOCATIONS.filter(loc => loc.name !== currentLocation.name).map(loc => ({ ...loc, distance: haversineDistance(currentLat, currentLon, loc.coordinates[1], loc.coordinates[0]) })).sort((a, b) => a.distance - b.distance).slice(0, count); }
        function getSpeciesSeasons(location) { const seasons = {}; if (location.speciesMonthly) { Object.entries(location.speciesMonthly).forEach(([species, months]) => { const activeMonths = months.map((active, i) => active ? MONTH_ABBR[i] : null).filter(Boolean); seasons[species] = activeMonths.length === 12 ? 'Year-round' : activeMonths.length > 0 ? `${activeMonths[0]}-${activeMonths[activeMonths.length - 1]}` : 'Seasonal'; }); } return seasons; }

        function updateHeroImage() {
            // Hero image is now static - only set the first image
            const img = document.getElementById('heroImage');
            img.src = locationImages[0];
        }

        function setupImageCarousel() {
            // Hero image carousel removed - now static cover image
            // Gallery images (excluding cover) handled separately
        }

        function renderPhotoGallery(location) {
            const allImages = location.imageUrls || [location.imageUrl];
            galleryImages = allImages.slice(1); // Exclude cover image
            
            if (galleryImages.length === 0) {
                document.getElementById('gallerySection').style.display = 'none';
                return;
            }
            
            document.getElementById('gallerySection').style.display = 'block';
            const gallery = document.getElementById('photoGallery');
            gallery.innerHTML = galleryImages.map((url, index) => 
                `<div class="gallery-item" data-index="${index}"><img src="${url}" alt="Gallery image ${index + 1}" loading="lazy"></div>`
            ).join('');
            
            // Add click handlers
            gallery.querySelectorAll('.gallery-item').forEach(item => {
                item.addEventListener('click', () => {
                    currentGalleryIndex = parseInt(item.dataset.index);
                    openLightbox();
                });
            });
        }

        function openLightbox() {
            const lightbox = document.getElementById('galleryLightbox');
            lightbox.classList.add('active');
            updateLightboxImage();
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            const lightbox = document.getElementById('galleryLightbox');
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
        }

        function updateLightboxImage() {
            const img = document.getElementById('lightboxImage');
            img.src = galleryImages[currentGalleryIndex];
            document.getElementById('lightboxCounter').textContent = `${currentGalleryIndex + 1} / ${galleryImages.length}`;
        }

        function setupGalleryLightbox() {
            document.getElementById('lightboxClose').addEventListener('click', closeLightbox);
            document.getElementById('lightboxPrev').addEventListener('click', () => {
                if (currentGalleryIndex > 0) {
                    currentGalleryIndex--;
                    updateLightboxImage();
                }
            });
            document.getElementById('lightboxNext').addEventListener('click', () => {
                if (currentGalleryIndex < galleryImages.length - 1) {
                    currentGalleryIndex++;
                    updateLightboxImage();
                }
            });
            document.getElementById('galleryLightbox').addEventListener('click', (e) => {
                if (e.target.id === 'galleryLightbox') closeLightbox();
            });
            document.addEventListener('keydown', (e) => {
                if (!document.getElementById('galleryLightbox').classList.contains('active')) return;
                if (e.key === 'Escape') closeLightbox();
                if (e.key === 'ArrowLeft' && currentGalleryIndex > 0) { currentGalleryIndex--; updateLightboxImage(); }
                if (e.key === 'ArrowRight' && currentGalleryIndex < galleryImages.length - 1) { currentGalleryIndex++; updateLightboxImage(); }
            });
        }

        function renderDescription(location) {
            const section = document.getElementById('descriptionSection');
            const descEl = document.getElementById('locationDescription');

            const html = location.fullDescription
                .split(/\n\s*\n/)              // split on blank lines
                .map(p => `<p>${p.trim()}</p>`)
                .join("");

            section.style.display = 'block';
            descEl.innerHTML = html;
        }


        const MAX_SPECIES_LEVELS = 5;
        function createMonthlyDensityChart(location) {
            const speciesMonthly = location.speciesMonthly;
            if (!speciesMonthly || typeof speciesMonthly !== 'object') return '';
            const orderedSpecies = Object.keys(speciesMonthly);
            const monthlyCounts = new Array(12).fill(0);
            orderedSpecies.forEach(sp => { const arr = speciesMonthly[sp] || []; for (let m = 0; m < 12; m++) { if (arr[m] > 0) monthlyCounts[m] += 1; } });
            if (!monthlyCounts.some(c => c > 0)) return '';
            const bars = monthlyCounts.map((count, monthIndex) => {
                if (!count) return `<div class="month-bar"><div class="bar-wrapper"><div class="stacked-bar" style="height:0%;"></div></div><div class="bar-label">${MONTH_ABBR[monthIndex]}</div></div>`;
                const presentSpecies = orderedSpecies.filter(sp => { const arr = speciesMonthly[sp]; return Array.isArray(arr) && arr[monthIndex] > 0; });
                const barHeightPercent = (Math.min(count, MAX_SPECIES_LEVELS) / MAX_SPECIES_LEVELS) * 100;
                const segments = presentSpecies.map(sp => `<div class="species-segment" style="background:${getSpeciesColor(sp)}; height:${100 / presentSpecies.length}%" title="${sp}"></div>`).join('');
                const tooltipSpecies = presentSpecies.map(sp => `<div class="tooltip-species"><span class="tooltip-color" style="background:${getSpeciesColor(sp)};"></span>${sp}</div>`).join('');
                return `<div class="month-bar"><div class="month-tooltip"><div class="tooltip-title">${MONTH_NAMES[monthIndex]}</div><div style="font-size:11px;margin-bottom:4px;">${count} species</div>${tooltipSpecies}</div><div class="bar-count">${count}</div><div class="bar-wrapper"><div class="stacked-bar" style="height:${barHeightPercent}%; min-height:4px;">${segments}</div></div><div class="bar-label">${MONTH_ABBR[monthIndex]}</div></div>`;
            }).join('');
            const legendItems = orderedSpecies.map(sp => `<div class="legend-item"><span class="legend-color" style="background:${getSpeciesColor(sp)};"></span>${sp.replace(' whale', '')}</div>`).join('');
            return `<div class="monthly-density-chart"><div class="chart-title">Species Stacked by Month<span style="display:block;font-size:10px;color:#777;margin-top:2px;">Stack order = dataset order (bottom = first species listed).</span></div><div class="month-bars">${bars}</div><div class="species-legend">${legendItems}</div></div>`;
        }

        function renderSpecies(location) { const grid = document.getElementById('speciesGrid'), seasons = getSpeciesSeasons(location); grid.innerHTML = location.species.map(species => `<div class="species-item"><div><div class="species-name">${species}</div><div class="species-season">${seasons[species] || 'Seasonal'}</div></div></div>`).join(''); }
        function renderMonthlyChart(location) { const container = document.getElementById('monthlyChart'), html = createMonthlyDensityChart(location); container.innerHTML = html || '<p style="margin:0;font-size:13px;color:#666;">Monthly activity data coming soon.</p>'; }
        function renderQuickFacts(location) { const container = document.getElementById('quickFacts'), accessibilityClass = location.accessibility.toLowerCase().replace(' ', '-'); container.innerHTML = `<div class="fact-item"><span class="fact-label">Accessibility</span><span class="accessibility-badge accessibility-${accessibilityClass}">${location.accessibility}</span></div><div class="fact-item"><span class="fact-label">Industry Size</span><span class="fact-value">${location.industrySize || 'N/A'}</span></div><div class="fact-item"><span class="fact-label">Annual Visitors</span><span class="fact-value">${formatVisitors(location.annualVisitors)}</span></div><div class="fact-item"><span class="fact-label">Species Count</span><span class="fact-value">${location.species.length} species</span></div><div class="fact-item"><span class="fact-label">Coordinates</span><span class="fact-value">${location.coordinates[1].toFixed(2)}째, ${location.coordinates[0].toFixed(2)}째</span></div>`; }
        function renderMonthsGrid(location) { document.getElementById('monthsGrid').innerHTML = MONTH_ABBR.map((month, i) => `<span class="month-badge ${location.bestMonths.includes(i + 1) ? 'active' : ''}">${month}</span>`).join(''); }
        function renderNearbyLocations(location) { const container = document.getElementById('nearbyLocations'), nearby = findNearbyLocations(location); container.innerHTML = nearby.map(loc => `<a href="location-detail.html?id=${generateLocationId(loc.name)}" class="nearby-item"><span class="nearby-distance">${loc.distance < 100 ? Math.round(loc.distance) : Math.round(loc.distance / 100) * 100} km</span><div><div class="nearby-name">${loc.name}</div><div class="nearby-region">${loc.location}</div></div></a>`).join(''); }

        function initMap(location) {
            mapboxgl.accessToken = MAPBOX_TOKEN;
            densityMap = new mapboxgl.Map({ container: 'mapContainer', style: 'mapbox://styles/mapbox/light-v11', center: location.coordinates, zoom: 4, interactive: true });
            densityMap.addControl(new mapboxgl.NavigationControl(), 'top-right');
            densityMap.on('load', () => {
                SPECIES_CONFIG.forEach(config => {
                    densityMap.addSource(config.sourceId, { type: 'vector', url: config.url });
                    densityMap.addLayer({ id: config.id, type: 'heatmap', source: config.sourceId, 'source-layer': config.sourceLayer, maxzoom: 9, filter: ['==', ['get', 'month'], currentMapMonth], paint: { ...HEATMAP_PAINT_BASE, 'heatmap-color': config.color.heatmap } }, 'waterway-label');
                    densityMap.addLayer({ id: `${config.id}-points`, type: 'circle', source: config.sourceId, 'source-layer': config.sourceLayer, filter: ['==', ['get', 'month'], currentMapMonth], paint: { 'circle-radius': ['interpolate', ['linear'], ['zoom'], 0, 3, 4, 5, 8, 8, 12, 12], 'circle-color': config.color.base, 'circle-opacity': 0.8, 'circle-stroke-width': 2, 'circle-stroke-color': 'white' }, layout: { 'visibility': 'none' } }, 'waterway-label');
                });
                new mapboxgl.Marker({ color: '#0a4a7c' }).setLngLat(location.coordinates).addTo(densityMap);
                updateLegend(); extractYears(); setupPointClicks();
            });
            setupMapControls();
        }

        function updateLegend() { document.getElementById('legendItems').innerHTML = SPECIES_CONFIG.map(config => `<div class="map-legend-item"><div class="map-legend-color" style="background: ${config.color.base}"></div><span class="map-legend-label">${config.name}</span></div>`).join(''); }

        function extractYears() {
            const yearsSet = new Set();
            SPECIES_CONFIG.forEach(config => { try { densityMap.querySourceFeatures(config.sourceId, { sourceLayer: config.sourceLayer }).forEach(f => { if (f.properties && f.properties.year) yearsSet.add(f.properties.year); }); } catch (e) {} });
            availableYears = Array.from(yearsSet).sort((a, b) => b - a);
            if (availableYears.length > 0) document.getElementById('yearSelect').innerHTML = '<option value="all">All Years</option>' + availableYears.map(y => `<option value="${y}">${y}</option>`).join('');
            densityMap.once('idle', () => {
                SPECIES_CONFIG.forEach(config => { try { densityMap.querySourceFeatures(config.sourceId, { sourceLayer: config.sourceLayer }).forEach(f => { if (f.properties && f.properties.year) yearsSet.add(f.properties.year); }); } catch (e) {} });
                availableYears = Array.from(yearsSet).sort((a, b) => b - a);
                if (availableYears.length > 0) document.getElementById('yearSelect').innerHTML = '<option value="all">All Years</option>' + availableYears.map(y => `<option value="${y}">${y}</option>`).join('');
            });
        }

        function setupPointClicks() {
            SPECIES_CONFIG.forEach(config => {
                const pointsLayerId = `${config.id}-points`;
                densityMap.on('mouseenter', pointsLayerId, () => { densityMap.getCanvas().style.cursor = 'pointer'; });
                densityMap.on('mouseleave', pointsLayerId, () => { densityMap.getCanvas().style.cursor = ''; });
                densityMap.on('click', pointsLayerId, (e) => {
                    if (e.features.length === 0) return;
                    const props = e.features[0].properties, coords = e.lngLat;
                    if (currentPopup) currentPopup.remove();
                    let popupHTML = `<div class="popup-title">${config.name}</div>`;
                    if (props.year) popupHTML += `<div class="popup-row"><strong>Year:</strong> ${props.year}</div>`;
                    if (props.month) popupHTML += `<div class="popup-row"><strong>Month:</strong> ${MONTH_NAMES[props.month - 1]}</div>`;
                    if (props.count) popupHTML += `<div class="popup-row"><strong>Count:</strong> ${props.count}</div>`;
                    if (props.source) popupHTML += `<div class="popup-row"><strong>Source:</strong> ${props.source}</div>`;
                    popupHTML += `<div class="popup-row"><strong>Location:</strong> ${coords.lat.toFixed(4)}째, ${coords.lng.toFixed(4)}째</div>`;
                    currentPopup = new mapboxgl.Popup({ closeOnClick: true, maxWidth: '280px' }).setLngLat(coords).setHTML(popupHTML).addTo(densityMap);
                });
            });
        }

        function setupMapControls() {
            document.querySelectorAll('.map-view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    if (view === currentView) return;
                    currentView = view;
                    document.querySelectorAll('.map-view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const yearSelect = document.getElementById('yearSelect');
                    if (view === 'points') { yearSelect.classList.remove('hidden'); }
                    else { yearSelect.classList.add('hidden'); }
                    updateMapView();
                });
            });
            document.getElementById('yearSelect').addEventListener('change', (e) => { currentYear = e.target.value; updateMapFilter(); });
            document.getElementById('mapMonthSlider').addEventListener('input', (e) => { currentMapMonth = parseInt(e.target.value); document.getElementById('mapMonthLabel').textContent = MONTH_ABBR[currentMapMonth - 1]; updateMapFilter(); });
            document.getElementById('expandBtn').addEventListener('click', toggleMapExpand);
            document.getElementById('mapOverlay').addEventListener('click', () => { if (isMapExpanded) toggleMapExpand(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && isMapExpanded) toggleMapExpand(); });
        }

        function updateMapView() {
            if (!densityMap) return;
            SPECIES_CONFIG.forEach(config => {
                const heatmapId = config.id, pointsId = `${config.id}-points`;
                if (currentView === 'heatmap') { if (densityMap.getLayer(heatmapId)) densityMap.setLayoutProperty(heatmapId, 'visibility', 'visible'); if (densityMap.getLayer(pointsId)) densityMap.setLayoutProperty(pointsId, 'visibility', 'none'); }
                else { if (densityMap.getLayer(heatmapId)) densityMap.setLayoutProperty(heatmapId, 'visibility', 'none'); if (densityMap.getLayer(pointsId)) densityMap.setLayoutProperty(pointsId, 'visibility', 'visible'); }
            });
            updateMapFilter();
        }

        function updateMapFilter() {
            if (!densityMap) return;
            SPECIES_CONFIG.forEach(config => {
                const heatmapId = config.id, pointsId = `${config.id}-points`;
                let filter = currentYear === 'all' ? ['==', ['get', 'month'], currentMapMonth] : ['all', ['==', ['get', 'month'], currentMapMonth], ['==', ['get', 'year'], parseInt(currentYear)]];
                if (densityMap.getLayer(heatmapId)) densityMap.setFilter(heatmapId, filter);
                if (densityMap.getLayer(pointsId)) densityMap.setFilter(pointsId, filter);
            });
        }

        function toggleMapExpand() {
            const mapCard = document.getElementById('mapCard'), overlay = document.getElementById('mapOverlay'), expandBtn = document.getElementById('expandBtn');
            isMapExpanded = !isMapExpanded;
            if (isMapExpanded) { mapCard.classList.add('expanded'); overlay.classList.add('visible'); expandBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14h6v6M14 4h6v6M20 20l-7-7M4 4l7 7"/></svg>Collapse`; }
            else { mapCard.classList.remove('expanded'); overlay.classList.remove('visible'); expandBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>Expand`; }
            setTimeout(() => { if (densityMap) densityMap.resize(); }, 350);
        }

        function initPage() {
            const locationId = getLocationId(), location = findLocation(locationId);
            if (!location) { document.getElementById('heroTitle').textContent = 'Location Not Found'; document.getElementById('heroTagline').textContent = 'The requested location could not be found.'; return; }
            document.title = `${location.name} - Whale Watching Atlas`;
            locationImages = location.imageUrls || [location.imageUrl];
            document.getElementById('heroImage').src = locationImages[0];
            document.getElementById('heroImage').alt = location.name;
            document.getElementById('regionName').textContent = location.location;
            document.getElementById('heroTitle').textContent = location.name;
            document.getElementById('heroTagline').textContent = location.specialNotes;
            document.getElementById('experienceScore').textContent = location.entertainment;
            document.getElementById('sightingScore').textContent = location.visibility;
            renderDescription(location); renderPhotoGallery(location); setupGalleryLightbox();
            renderSpecies(location); renderMonthlyChart(location); renderQuickFacts(location); renderMonthsGrid(location); renderNearbyLocations(location); initMap(location);
            if (location.bestMonths && location.bestMonths.length > 0) { const bestMonth = location.bestMonths[0]; document.getElementById('mapMonthSlider').value = bestMonth; currentMapMonth = bestMonth; document.getElementById('mapMonthLabel').textContent = MONTH_ABBR[bestMonth - 1]; }
        }

        document.addEventListener('DOMContentLoaded', initPage);

        // Mobile Legend Toggle
        (function() {
            const legendToggle = document.getElementById('mapLegendToggle');
            const legend = document.getElementById('mapLegend');
            const legendClose = document.getElementById('mapLegendClose');

            function openLegend() {
                legend.classList.add('mobile-visible');
                legendToggle.classList.add('active');
            }

            function closeLegend() {
                legend.classList.remove('mobile-visible');
                legendToggle.classList.remove('active');
            }

            if (legendToggle) {
                legendToggle.addEventListener('click', function() {
                    if (legend.classList.contains('mobile-visible')) {
                        closeLegend();
                    } else {
                        openLegend();
                    }
                });
            }

            if (legendClose) {
                legendClose.addEventListener('click', closeLegend);
            }
        })();

        // Mobile nav toggle
        const navbar = document.getElementById('navbar');
        const navToggle = navbar ? navbar.querySelector('.nav-toggle') : null;
        if (navToggle && navbar) {
            navToggle.addEventListener('click', () => {
                navbar.classList.toggle('nav-open');
            });
            navbar.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => navbar.classList.remove('nav-open'));
            });
        }
    </script>

    <footer class="site-footer">
        <div class="footer-content">
            <p class="footer-attribution"><a href="about.html">Created by Tyree Spatial</a></p>
        </div>
    </footer>
</body>
</html>
